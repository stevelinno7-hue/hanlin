(function (global) {
  'use strict';

  function init() {
    const G = global.RigorousGenerator || global?.global?.RigorousGenerator;
    if (!G || !G.registerTemplate) return setTimeout(init, 100);

    const { pick, shuffle } = G.utils;

    const sciDB = [

        // ==========================================
        // 2. 地球科學 (Earth Science)
        // ==========================================
        // [國九] 天文
        { s:"地科", t:["國九","天文"], q: "地球自轉造成的現象", a: "晝夜交替" },
        { s:"地科", t:["國九","天文"], q: "地球公轉造成的現象", a: "四季變化" },
        { s:"地科", t:["國九","天文"], q: "太陽系最大的行星", a: "木星" },
        { s:"地科", t:["國九","天文"], q: "類地行星特徵", a: "體積小、密度大、岩石組成" },
        { s:"地科", t:["國九","天文"], q: "類木行星特徵", a: "體積大、密度小、氣體組成" },
        { s:"地科", t:["國九","天文"], q: "月相變化的週期", a: "約 29.5 天 (朔望月)" },
        { s:"地科", t:["國九","天文"], q: "日食發生的農曆日期", a: "朔 (初一)" },
        { s:"地科", t:["國九","天文"], q: "月食發生的農曆日期", a: "望 (十五)" },
        { s:"地科", t:["國九","天文"], q: "織女星屬於", a: "恆星" },
        { s:"地科", t:["國九","天文"], q: "光年是單位的", a: "距離" },

        // [國九] 地質
        { s:"地科", t:["國九","地質"], q: "板塊構造運動的動力來源", a: "地函熱對流" },
        { s:"地科", t:["國九","地質"], q: "台灣位於哪兩板塊交界", a: "歐亞板塊與菲律賓海板塊" },
        { s:"地科", t:["國九","地質"], q: "聚合性板塊邊界特徵", a: "海溝、火山、造山運動" },
        { s:"地科", t:["國九","地質"], q: "張裂性板塊邊界特徵", a: "中洋脊、裂谷" },
        { s:"地科", t:["國九","地質"], q: "花岡岩屬於", a: "火成岩" },
        { s:"地科", t:["國九","地質"], q: "大理岩屬於", a: "變質岩" },
        { s:"地科", t:["國九","地質"], q: "石灰岩屬於", a: "沈積岩" },
        { s:"地科", t:["國九","地質"], q: "地震規模的定義", a: "釋放能量的多寡" },
        { s:"地科", t:["國九","地質"], q: "地震震度的定義", a: "地面搖晃的程度" },

        // [國九] 大氣與海洋
        { s:"地科", t:["國九","大氣"], q: "天氣現象發生的那一層", a: "對流層" },
        { s:"地科", t:["國九","大氣"], q: "臭氧層所在位置", a: "平流層" },
        { s:"地科", t:["國九","大氣"], q: "大氣中含量最多的氣體", a: "氮氣" },
        { s:"地科", t:["國九","大氣"], q: "造成溫室效應的主要氣體", a: "二氧化碳、甲烷、水氣" },
        { s:"地科", t:["國九","大氣"], q: "高氣壓中心的氣流", a: "下沉、順時針旋轉(北半球)" },
        { s:"地科", t:["國九","大氣"], q: "低氣壓中心的氣流", a: "上升、逆時針旋轉(北半球)" },
        { s:"地科", t:["國九","大氣"], q: "冷鋒通過時的天氣", a: "氣溫下降、降雨" },
        { s:"地科", t:["國九","海洋"], q: "造成潮汐的主因", a: "月球與太陽的引力" },
        { s:"地科", t:["國九","海洋"], q: "黑潮是", a: "暖流" },

        // [高中] 進階地科
        { s:"地科", t:["高一","天文"], q: "宇宙背景輻射證明了", a: "大霹靂理論" },
        { s:"地科", t:["高一","天文"], q: "哈伯定律描述", a: "宇宙正在膨脹" },
        { s:"地科", t:["高一","天文"], q: "星等數值越小", a: "亮度越亮" },
        { s:"地科", t:["高一","地質"], q: "絕對地質年代測定", a: "放射性元素定年法" },
        { s:"地科", t:["高一","氣候"], q: "聖嬰現象特徵", a: "東太平洋海水異常增溫" },
        { s:"地科", t:["高一","氣候"], q: "科氏力在北半球", a: "向右偏轉" },
        { s:"地科", t:["高一","海洋"], q: "溫鹽環流的驅動力", a: "密度差異(溫度與鹽度)" },

        // ==========================================
        // 3. 物理 (Physics)
        // ==========================================
        // [國八] 力學與測量
        { s:"物理", t:["國八","測量"], q: "國際單位制(SI)長度單位", a: "公尺 (m)" },
        { s:"物理", t:["國八","測量"], q: "國際單位制(SI)質量單位", a: "公斤 (kg)" },
        { s:"物理", t:["國八","測量"], q: "密度的定義", a: "質量除以體積 (D=M/V)" },
        { s:"物理", t:["國八","力學"], q: "力的單位(SI)", a: "牛頓 (N)" },
        { s:"物理", t:["國八","力學"], q: "虎克定律", a: "彈簧伸長量與受力成正比" },
        { s:"物理", t:["國八","力學"], q: "摩擦力的方向", a: "與運動方向相反" },
        { s:"物理", t:["國八","力學"], q: "阿基米德原理", a: "浮力等於排開液重" },
        { s:"物理", t:["國八","力學"], q: "壓力的定義", a: "單位面積所受的力 (P=F/A)" },

        // [國八] 熱、波、光
        { s:"物理", t:["國八","熱"], q: "溫度的微觀意義", a: "分子的平均動能" },
        { s:"物理", t:["國八","熱"], q: "比熱大的物質", a: "難熱難冷" },
        { s:"物理", t:["國八","熱"], q: "熱傳導", a: "固體的主要傳熱方式" },
        { s:"物理", t:["國八","熱"], q: "熱對流", a: "流體的主要傳熱方式" },
        { s:"物理", t:["國八","熱"], q: "熱輻射", a: "不需介質的傳熱方式" },
        { s:"物理", t:["國八","波動"], q: "聲波屬於", a: "縱波 (力學波)" },
        { s:"物理", t:["國八","波動"], q: "光波屬於", a: "橫波 (電磁波)" },
        { s:"物理", t:["國八","波動"], q: "聲音的三要素", a: "響度、音調、音色" },
        { s:"物理", t:["國八","波動"], q: "音調決定於", a: "頻率" },
        { s:"物理", t:["國八","波動"], q: "響度決定於", a: "振幅" },
        { s:"物理", t:["國八","光"], q: "光的三原色", a: "紅、綠、藍" },
        { s:"物理", t:["國八","光"], q: "平面鏡成像性質", a: "正立、相等、虛像" },
        { s:"物理", t:["國八","光"], q: "凸透鏡成像", a: "可聚光，可成實像或虛像" },
        { s:"物理", t:["國八","光"], q: "近視眼矯正", a: "凹透鏡" },

        // [國九] 運動與電磁
        { s:"物理", t:["國九","運動"], q: "位移", a: "起點到終點的直線距離與方向" },
        { s:"物理", t:["國九","運動"], q: "速度", a: "位移除以時間 (具方向性)" },
        { s:"物理", t:["國九","運動"], q: "加速度", a: "單位時間內速度的變化量" },
        { s:"物理", t:["國九","運動"], q: "牛頓第一運動定律", a: "慣性定律" },
        { s:"物理", t:["國九","運動"], q: "牛頓第二運動定律", a: "F = ma" },
        { s:"物理", t:["國九","運動"], q: "牛頓第三運動定律", a: "作用力與反作用力" },
        { s:"物理", t:["國九","能量"], q: "動能公式", a: "1/2 mv²" },
        { s:"物理", t:["國九","能量"], q: "重力位能公式", a: "mgh" },
        { s:"物理", t:["國九","能量"], q: "功率的定義", a: "單位時間內所作的功" },
        { s:"物理", t:["國九","電學"], q: "歐姆定律", a: "V = IR" },
        { s:"物理", t:["國九","電學"], q: "串聯電路", a: "電流相同，電壓相加" },
        { s:"物理", t:["國九","電學"], q: "並聯電路", a: "電壓相同，電流相加" },
        { s:"物理", t:["國九","電學"], q: "伏特計連接方式", a: "並聯" },
        { s:"物理", t:["國九","電學"], q: "安培計連接方式", a: "串聯" },
        { s:"物理", t:["國九","磁學"], q: "安培右手定則", a: "判斷電流產生的磁場方向" },
        { s:"物理", t:["國九","磁學"], q: "法拉第定律", a: "磁場變化產生感應電流" },

        // [高中] 進階物理
        { s:"物理", t:["高一","運動"], q: "斜向拋射", a: "水平等速，鉛直等加" },
        { s:"物理", t:["高一","力學"], q: "動量守恆條件", a: "系統不受外力" },
        { s:"物理", t:["高一","引力"], q: "萬有引力定律", a: "F = GMm/r²" },
        { s:"物理", t:["高一","引力"], q: "克卜勒第一定律", a: "行星軌道為橢圓" },
        { s:"物理", t:["高二","光學"], q: "干涉現象證明光具有", a: "波動性" },
        { s:"物理", t:["高二","近代"], q: "光電效應證明光具有", a: "粒子性" },
        { s:"物理", t:["高二","近代"], q: "波粒二象性", a: "光與物質同時具有波動與粒子性質" },

    ];

    function makeSciQ(subject, grade) {
      const pool = sciDB.filter(x => x.s === subject && x.t[0] === grade);
      if (pool.length < 4) return null;

      const item = pick(pool);
      const wrong = shuffle(pool.filter(x => x !== item)).slice(0,3).map(x => x.a);
      const opts = shuffle([item.a, ...wrong]);

      return {
        question: `【${subject}｜${grade}】${item.q}`,
        options: opts,
        answer: opts.indexOf(item.a),
        explanation: [`正確答案：${item.a}`]
      };
    }

    G.registerTemplate("physics_g8", () => makeSciQ("物理","國八"), ["物理","國八"]);
    G.registerTemplate("physics_g9", () => makeSciQ("物理","國九"), ["物理","國九"]);
    G.registerTemplate("earth_g9",   () => makeSciQ("地科","國九"), ["地科","國九"]);

    console.log("✅ 物理／地科題庫載入完成");
  }

  init();
})(window);
