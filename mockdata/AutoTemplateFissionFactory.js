(function(global){
    'use strict';

    // å®šç¾©å•Ÿå‹•å‡½å¼
    function initFactory() {
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        
        // 1. å¦‚æœå¼•æ“é‚„æ²’å¥½ï¼Œç¨å¾®ç­‰ä¸€ä¸‹
        if (!G) {
            setTimeout(initFactory, 50);
            return;
        }

        // ==========================================
        //  1. æƒ…å¢ƒè³‡æ–™åº« (Context Database)
        // ==========================================
        const DB = {
            // [è·æ¥­/è§’è‰²]
            roles: [
                "AIå·¥ç¨‹å¸«", "å…¨ç«¯å·¥ç¨‹å¸«", "é›»ç«¶é¸æ‰‹", "YouTuber", "å¤–é€å“¡", 
                "è‚¡å¸‚åˆ†æå¸«", "å»ºç¯‰å¸«", "æ€¥è¨ºå®¤é†«ç”Ÿ", "ä¾¿åˆ©å•†åº—åº—å“¡", "å¥èº«æ•™ç·´",
                "FBIæ¢å“¡", "é»‘å®¢", "æ³•é†«", "æ©Ÿé•·", "æ–°èä¸»æ’­",
                "ç«æ˜Ÿå¤ªç©ºäºº", "æ™‚ç©ºæ—…äºº", "å¸è¡€é¬¼çµäºº", "é­”æ³•å­¸å¾’", "ç…‰é‡‘è¡“å£«",
                "é¦´é¾é«˜æ‰‹", "æ·±æµ·æ½›æ°´å“¡", "å¿è€…", "æµ·ç›œèˆ¹é•·", "æ®­å±å€–å­˜è€…",
                "è€ƒå¤å­¸å®¶", "ç§å®¶åµæ¢", "ç‰¹å‹™ 007", "è¶…èƒ½åŠ›è€…", "çµ•åœ°æ­¦å£«",
                "ç±³å…¶æ—ä¸»å»š", "å‹•ç‰©æ£®å‹æœƒç©å®¶", "é¥’èˆŒæ­Œæ‰‹", "ç¸½çµ±", "æµæµªæ¼¢",
                "å¯ŒäºŒä»£", "æ¤ç‰©å­¸å®¶", "å¹¼ç¨šåœ’è€å¸«", "å…¬è»Šå¸æ©Ÿ", "ç®—å‘½å¸«",
                "å‚¬çœ å¸«", "é­”è¡“å¸«", "é¦´ç¸å¸«", "ç™»å±±å®¢", "æ¥µé™é‹å‹•å“¡",
                "æ‹è³£å®˜", "åœ–æ›¸é¤¨ç®¡ç†å“¡", "åšç‰©é¤¨é©šé­‚å¤œè­¦è¡›", "å‹•ç‰©åœ’é£¼è‚²å“¡", "éŸå±å®˜"
            ],

            // [å ´æ™¯/åœ°é»]
            places: [
                "åœ¨å…¨è¯ç¦åˆ©ä¸­å¿ƒ", "åœ¨ 101 å¤§æ¨“é ‚ç«¯", "åœ¨æ’’å“ˆæ‹‰æ²™æ¼ ", "åœ¨ç‰å±±å±±é ‚",
                "åœ¨ IKEA è¿·å®®", "åœ¨æ ¸é›»å» æ§åˆ¶å®¤", "åœ¨æ‰‹è¡“å®¤", "åœ¨æ³•é™¢è­‰äººå¸­",
                "åœ¨æ¼”å”±æœƒå¾Œå°", "åœ¨æ“ æ»¿äººçš„æ·é‹è»Šå»‚", "åœ¨ç„¡äººå³¶", "åœ¨å—æ¥µç ”ç©¶ç«™",
                "åœ¨ç¾…æµ®å®®", "åœ¨è¿ªå£«å°¼æ¨‚åœ’", "åœ¨åœ‹éš›å¤ªç©ºç«™", "åœ¨æ½›æ°´è‰‡è£¡",
                "åœ¨ç™¾æ…•é”ä¸‰è§’æ´²", "åœ¨éœæ ¼è¯èŒ²é­”æ³•å­¸æ ¡", "åœ¨æµ·åº•å…©è¬å“©", "åœ¨å–ªå±åœåŸçš„è³£å ´",
                "åœ¨æ™‚å…‰æ©Ÿè£¡", "åœ¨ç›´æ’­é–“", "åœ¨é»‘æ´é‚Šç·£", "åœ¨é‡‘å­—å¡”å¯†å®¤",
                "åœ¨å¤ç¾…é¦¬ç«¶æŠ€å ´", "åœ¨å…ƒå®‡å®™", "åœ¨å¬å–šå³½è°·", "åœ¨ä¾ç¾…ç´€å…¬åœ’",
                "åœ¨éµé”å°¼è™Ÿæ²ˆèˆ¹æ—", "åœ¨æœˆçƒèƒŒé¢", "åœ¨ç•°ä¸–ç•Œè½‰ç”Ÿé»", "åœ¨é¬¼å±‹",
                "åœ¨ç³–æœå±‹", "åœ¨å¤©ç©ºä¹‹åŸ", "åœ¨äºç‰¹è˜­ææ–¯", "åœ¨ç«æ˜Ÿæ®–æ°‘åœ°"
            ],

            // [æ ¼å¼/è¼‰é«”]
            formats: [
                { type: "news", label: "æ–°è", tpl: (q)=>`ã€ç·Šæ€¥å¿«è¨Šã€‘æ“šæœ€æ–°å ±å°æŒ‡å‡ºï¼š\n${q}\nå°ˆå®¶è¡¨ç¤ºé€™å°‡å½±éŸ¿å…¨çƒå±€å‹¢ã€‚` },
                { type: "diary", label: "æ—¥è¨˜", tpl: (q)=>`ã€æ¢éšªæ—¥è¨˜ Day 42ã€‘\nä»Šå¤©ç™¼ç”Ÿäº†å¥‡æ€ªçš„äº‹ï¼š\n${q}\næˆ‘è©²æ€éº¼è¾¦ï¼Ÿ` },
                { type: "email", label: "ä¿¡ä»¶", tpl: (q)=>`Subject: ç·Šæ€¥æ±‚åŠ©\nTo: æ•™æˆ\n\næˆ‘åœ¨ç ”ç©¶ä¸­é‡åˆ°äº†ç“¶é ¸ï¼š\n${q}\nç›¼è¦†ã€‚` },
                { type: "chat", label: "å°è©±", tpl: (q)=>`Aï¼šã€Œæ¬¸ï¼Œè€ƒä½ ä¸€é¡Œã€‚ã€\nBï¼šã€Œæ”¾é¦¬éä¾†ã€‚ã€\nAï¼šã€Œ${q}ã€\nBï¼šã€Œé€™...ã€` },
                { type: "post", label: "ç¤¾ç¾¤", tpl: (q)=>`#æ€¥ #åœ¨ç·šç­‰ #æ±‚æ•‘\n${q}\nç­”å°çš„è«‹å–çå¥¶ï¼ğŸ¥¤` },
                { type: "system", label: "ç³»çµ±", tpl: (q)=>`[SYSTEM WARNING]\nåµæ¸¬åˆ°é‚è¼¯éŒ¯èª¤ï¼š\n${q}\nè«‹è¼¸å…¥æ­£ç¢ºæŒ‡ä»¤ä»¥ä¿®å¾©ç³»çµ±ã€‚` },
                { type: "exam", label: "è©¦é¡Œ", tpl: (q)=>`ã€115å¹´å­¸æ¸¬ æ¨¡æ“¬è©¦é¡Œã€‘\n${q}` },
                { type: "quest", label: "ä»»å‹™", tpl: (q)=>`ã€ä¸»ç·šä»»å‹™æ›´æ–°ã€‘\nNPC çµ¦äº†ä½ ä¸€å€‹è¬é¡Œï¼š\n${q}\nè§£é–‹å¾Œå¯ç²å¾—å‚³èªªè£å‚™ã€‚` },
                { type: "video", label: "çŸ­å½±éŸ³", tpl: (q)=>`ã€æŠ–éŸ³æŒ‘æˆ°ã€‘å¦‚æœä½ èƒ½åœ¨ä¸€åˆ†é˜å…§å›ç­”é€™å€‹å•é¡Œï¼š\nã€Œ${q}ã€\nä½ å°±æ˜¯å¤©æ‰ï¼` },
                { type: "memo", label: "ä¾¿æ¢", tpl: (q)=>`å†°ç®±ä¸Šè²¼è‘—ä¸€å¼µç´™æ¢ï¼š\nã€Œå‡ºé–€å‰è¨˜å¾—è™•ç†é€™ä»¶äº‹ï¼š${q}ã€` }
            ]
        };

        // ==========================================
        //  2. å»ºæ§‹æƒ…å¢ƒç”Ÿæˆå™¨ (Context Generators)
        // ==========================================
        const CONTEXT_WRAPPERS = {};
        const { pick } = G.utils;

        // A. åŸºç¤æ¨™æº–ç‰ˆ
        CONTEXT_WRAPPERS['standard'] = (q) => q;

        // B. è§’è‰²æ‰®æ¼”ç‰ˆ (å‹•æ…‹éš¨æ©Ÿ)
        for (let i = 0; i < 50; i++) {
            CONTEXT_WRAPPERS[`roleplay_${i}`] = (q) => {
                const r = pick(DB.roles);
                const p = pick(DB.places);
                return `ã€æƒ…å¢ƒï¼š${r}ã€‘\nä½ ç¾åœ¨${p}ï¼Œçœ¼å‰å‡ºç¾äº†ä¸€å€‹é›£é¡Œï¼š\nã€Œ${q}ã€\nèº«ç‚ºå°ˆæ¥­çš„${r}ï¼Œä½ è©²å¦‚ä½•è§£æ±ºï¼Ÿ`;
            };
        }

        // C. æ ¼å¼è®ŠåŒ–ç‰ˆ
        DB.formats.forEach((fmt) => {
            CONTEXT_WRAPPERS[fmt.type] = fmt.tpl;
        });

        // ==========================================
        //  3. [é—œéµä¿®æ­£] å®šç¾©èˆ‡æ›è¼‰è‡ªå‹•è£‚è®ŠåŠŸèƒ½
        // ==========================================
        
        // é€™æ˜¯ Bootstrap åœ¨å°‹æ‰¾çš„å‡½å¼ï¼Œå¿…é ˆæ›è¼‰åˆ° G ç‰©ä»¶ä¸Šï¼
        G.autoFissionRegister = function(originalId, originalFunc, tags, rawRegister) {
            
            // æ­¥é©Ÿ A: å…ˆè¨»å†Šä¸€å€‹ã€ŒåŸå§‹ç‰ˆæœ¬ã€çš„é¡Œç›®
            rawRegister.call(G, originalId, originalFunc, tags);

            // æ­¥é©Ÿ B: é€²è¡Œè£‚è®Š (é€™è£¡ç¤ºç¯„éš¨æ©ŸæŒ‘é¸ä¸€ç¨®æƒ…å¢ƒé€²è¡Œè®Šé«”)
            // ç‚ºäº†ä¸è®“é¡Œç›®çˆ†ç‚¸å¤šï¼Œæˆ‘å€‘æ¯å€‹é¡Œç›®åªé¡å¤–ç”Ÿæˆä¸€å€‹è®Šé«”
            const wrapperKeys = Object.keys(CONTEXT_WRAPPERS).filter(k => k !== 'standard');
            const randomKey = pick(wrapperKeys);
            const wrapperFunc = CONTEXT_WRAPPERS[randomKey];

            const fissionId = `${originalId}_fission_${randomKey}`;
            
            // å»ºç«‹æ–°çš„è®Šé«”é¡Œç›®å‡½å¼
            const newFunc = function(ctx, rnd) {
                const baseData = originalFunc(ctx, rnd);
                // ç¢ºä¿é¡Œç›®æ˜¯å­—ä¸²æ‰èƒ½åŒ…è£
                if (typeof baseData.question === 'string') {
                    return {
                        ...baseData,
                        question: wrapperFunc(baseData.question),
                        concept: `${baseData.concept} (ç´ é¤Šæ‡‰ç”¨)`, // åŠ ä¸Šæ¨™ç±¤å€éš”
                        templateId: fissionId
                    };
                }
                return baseData;
            };

            // è¨»å†Šé€™å€‹æ–°çš„è®Šé«”é¡Œç›®
            rawRegister.call(G, fissionId, newFunc, [...tags, "ç´ é¤Šé¡Œ", "æƒ…å¢ƒæ‡‰ç”¨"]);
        };

        console.log(`âœ… è‡ªå‹•è£‚è®Šå·¥å» å·²å°±ç·’ï¼šå·²ç”Ÿæˆ ${Object.keys(CONTEXT_WRAPPERS).length} ç¨®æƒ…å¢ƒæ¨¡çµ„ã€‚`);
    }

    // ç«‹å³å•Ÿå‹•å·¥å»  (ä¸è¦ç”¨ window.load åŒ…èµ·ä¾†ï¼)
    initFactory();

})(window);
