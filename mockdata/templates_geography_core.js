(function (global) {
    'use strict';

    // 等待引擎就緒
    function waitForEngine(callback) {
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        if (!G || !G.registerTemplate) {
            setTimeout(() => waitForEngine(callback), 100);
            return;
        }
        callback(G);
    }

    // 地理核心資料庫 (完整保留你的資料)
    const geoDB = [
        // [國七] 地形
        { s:"地理", t:["國七","地形"], e:"河谷地形", y:"V型谷", p:"河流侵蝕", k:"上游", d:"河流上游侵蝕力強，下切形成深谷" },
        { s:"地理", t:["國七","地形"], e:"沖積扇", y:"扇狀堆積", p:"河流堆積", k:"谷口", d:"河流出谷口流速減緩，泥沙堆積成扇狀" },
        { s:"地理", t:["國七","地形"], e:"三角洲", y:"河口堆積", p:"河流", k:"出海口", d:"河流入海處流速極慢，泥沙堆積成三角形" },
        { s:"地理", t:["國七","地形"], e:"石灰岩地形", y:"喀斯特", p:"溶蝕作用", k:"鐘乳石", d:"地下水溶蝕石灰岩層形成的特殊地形" },
        { s:"地理", t:["國七","地形"], e:"沙洲與潟湖", y:"波浪堆積", p:"沿海", k:"濱外沙洲", d:"沿岸流與波浪搬運堆積形成的海積地形" },
        { s:"地理", t:["國七","地形"], e:"火山地形", y:"火山錐", p:"岩漿活動", k:"火山口", d:"岩漿噴出冷卻堆積形成火山錐與火山口" },
        { s:"地理", t:["國七","地形"], e:"冰蝕地形", y:"U型谷", p:"冰川侵蝕", k:"冰蝕湖", d:"冰川推移侵蝕山谷，形成寬廣的U型谷" },
        { s:"地理", t:["國七","地形"], e:"懸崖與海蝕平台", y:"海蝕崖", p:"波浪侵蝕", k:"海蝕洞", d:"海浪長期侵蝕海岸，形成懸崖與平台" },
        { s:"地理", t:["國七","地形"], e:"潟湖", y:"潟湖", p:"沙嘴封閉", k:"潟湖生態", d:"沙嘴或沙洲將海灣封閉，形成內側潟湖" },
        { s:"地理", t:["國七","地形"], e:"斷層地形", y:"斷層崖", p:"地殼運動", k:"地震帶", d:"地殼斷裂位移形成的地形，如斷層崖" },
        { s:"地理", t:["國七","地形"], e:"河階", y:"階地", p:"河流侵蝕與堆積", k:"階地台地", d:"河流下切與河床抬升形成的階狀地形" },
        { s:"地理", t:["國七","地形"], e:"潛流與地下水", y:"含水層", p:"滲透與補給", k:"井水", d:"降水滲入地下形成含水層，供應井水與泉源" },
        { s:"地理", t:["國七","地形"], e:"潟湖沙嘴", y:"沙嘴形成", p:"長岸流", k:"封閉海灣", d:"長岸流搬運沉積物形成沙嘴，封閉海灣形成潟湖" },
        
        // [國七] 氣候
        { s:"地理", t:["國七","氣候"], e:"季風氣候", y:"夏雨冬乾", p:"海陸性質差異", k:"轉向", d:"夏季吹海風多雨，冬季吹陸風乾燥" },
        { s:"地理", t:["國七","氣候"], e:"地形雨", y:"迎風坡多雨", p:"地形抬升", k:"背風坡", d:"氣流受山脈阻擋抬升，冷卻凝結降雨" },
        { s:"地理", t:["國七","氣候"], e:"沙漠氣候", y:"乾旱少雨", p:"副熱帶高壓", k:"日夜溫差大", d:"全年降水稀少，日夜溫差顯著" },
        { s:"地理", t:["國七","氣候"], e:"溫帶大陸性氣候", y:"冬冷夏熱", p:"內陸位置", k:"年溫差大", d:"遠離海洋調節，季節溫差與日夜溫差大" },
        { s:"地理", t:["國七","氣候"], e:"颱風", y:"熱帶氣旋", p:"海洋熱能", k:"暴雨與強風", d:"颱風由海洋熱能驅動，帶來強風與豪雨" },
        { s:"地理", t:["國七","氣候"], e:"海洋性氣候", y:"溫和多雨", p:"海洋調節", k:"沿海地區", d:"海洋調節使沿海地區氣候溫和且降雨分布均勻" },

        // [國七] 產業與其他
        { s:"地理", t:["國七","產業"], e:"集約農業", y:"投入多產出高", p:"水稻", k:"勞力密集", d:"單位面積投入大量勞力與資金的農業" },
        { s:"地理", t:["國七","產業"], e:"漁業", y:"近海漁場", p:"洋流交會", k:"漁獲豐富", d:"寒暖流交會處浮游生物多，形成良好漁場" },
        { s:"地理", t:["國七","產業"], e:"牧業", y:"放牧", p:"草原", k:"遊牧", d:"以放牧為主的畜牧業，常見於草原或乾燥地帶" },
        { s:"地理", t:["國七","產業"], e:"工業區", y:"重化工", p:"資源與交通", k:"污染", d:"工業區集中生產，但可能帶來環境污染問題" },

        // [國八] 中國
        { s:"地理", t:["國八","中國"], e:"黃土高原", y:"窯洞", p:"風力堆積", k:"水土流失", d:"土質疏鬆，易受流水侵蝕，形成溝壑縱橫" },
        { s:"地理", t:["國八","中國"], e:"坎兒井", y:"乾燥氣候", p:"新疆", k:"暗渠", d:"減少水分蒸發的古老水利設施" },
        { s:"地理", t:["國八","中國"], e:"長江三角洲", y:"水鄉澤國", p:"水運", k:"魚米之鄉", d:"河網密布，中國經濟最發達的地區" },
        { s:"地理", t:["國八","中國"], e:"華北平原", y:"沖積平原", p:"黃河沖積", k:"小麥帶", d:"地勢平坦，土壤肥沃，是重要農業區" },
        { s:"地理", t:["國八","中國"], e:"四川盆地", y:"盆地氣候", p:"地形封閉", k:"天府之國", d:"四周環山，氣候溫暖濕潤，農業發達" },
        { s:"地理", t:["國八","中國"], e:"西藏高原", y:"世界屋脊", p:"板塊抬升", k:"高寒", d:"海拔高、氣候寒冷，地形以高原為主" },
        { s:"地理", t:["國八","中國"], e:"珠江三角洲", y:"經濟圈", p:"河網密布", k:"都市化", d:"河流沖積平原與沿海發展出密集都市帶" },
        { s:"地理", t:["國八","中國"], e:"台灣地形", y:"中央山脈", p:"造山運動", k:"斷層活動", d:"島嶼狹長，中央山脈縱貫南北，地形起伏大" },
        { s:"地理", t:["國八","中國"], e:"東北平原", y:"黑土地", p:"冰川與河流作用", k:"玉米大豆", d:"土壤肥沃，適合大面積機械化耕作" },
        { s:"地理", t:["國八","中國"], e:"長江流域", y:"水運樞紐", p:"河流交通", k:"水利工程", d:"長江提供內陸水運與灌溉，是重要經濟帶" },
        { s:"地理", t:["國八","中國"], e:"黃河流域", y:"泥沙多", p:"上游侵蝕", k:"河道淤積", d:"黃土高原供給大量泥沙，河道易改道" },
        { s:"地理", t:["國八","中國"], e:"雲南喀斯特", y:"石林", p:"溶蝕", k:"喀斯特地形", d:"石灰岩溶蝕形成奇特的石林與溶洞" },
        { s:"地理", t:["國八","中國"], e:"東南沿海", y:"台風頻繁", p:"熱帶氣旋", k:"防風堤", d:"受西北太平洋颱風影響，沿海地區需防災" },
        { s:"地理", t:["國八","中國"], e:"長江中下游", y:"稻米帶", p:"水利灌溉", k:"河網", d:"水網密集，適合水稻栽培與水運發展" },
        { s:"地理", t:["國八","中國"], e:"海南島", y:"熱帶島嶼", p:"旅遊業", k:"熱帶農業", d:"熱帶氣候適合熱帶作物與觀光發展" },
        { s:"地理", t:["國八","中國"], e:"台灣西部平原", y:"沖積平原", p:"河流沉積", k:"農業與都市", d:"平原地帶為主要農業區與都市發展區" },

        // [國九] 世界
        { s:"地理", t:["國九","世界"], e:"熱帶雨林", y:"亞馬遜", p:"赤道", k:"對流雨", d:"全年高溫多雨，生物多樣性高" },
        { s:"地理", t:["國九","世界"], e:"熱帶莽原", y:"乾溼分明", p:"獅子斑馬", k:"薩凡納", d:"受赤道低壓與副熱帶高壓交替控制，乾溼季明顯" },
        { s:"地理", t:["國九","世界"], e:"地中海型氣候", y:"夏乾冬雨", p:"西風帶", k:"橄欖葡萄", d:"夏季乾燥少雨，冬季受西風吹拂多雨" },
        { s:"地理", t:["國九","世界"], e:"溫帶海洋性", y:"全年有雨", p:"西歐", k:"西風吹拂", d:"終年受西風與暖流影響，氣候溫和濕潤" },
        { s:"地理", t:["國九","世界"], e:"撒哈拉沙漠", y:"世界最大熱帶沙漠", p:"乾燥氣候", k:"沙丘", d:"極度乾燥，植被稀少，日夜溫差大" },
        { s:"地理", t:["國九","世界"], e:"剛果雨林", y:"熱帶雨林", p:"赤道濕潤", k:"生物多樣性", d:"高降雨與高溫，擁有豐富的生態系" },
        { s:"地理", t:["國九","世界"], e:"喜馬拉雅山", y:"世界最高山脈", p:"板塊擠壓", k:"造山運動", d:"印度板塊與歐亞板塊碰撞抬升形成高山" },
        { s:"地理", t:["國九","世界"], e:"澳洲大平原", y:"內陸乾燥", p:"遠離海洋", k:"牧羊業", d:"地廣人稀，適合大規模放牧" },
        { s:"地理", t:["國九","世界"], e:"北美大平原", y:"穀倉地帶", p:"冰川沉積", k:"小麥玉米", d:"肥沃土壤適合穀物大面積耕作" },
        { s:"地理", t:["國九","世界"], e:"歐洲工業帶", y:"產業集中", p:"交通便利", k:"都市化", d:"河流與海港促進工業與都市發展" },
        { s:"地理", t:["國九","世界"], e:"日本列島", y:"島弧", p:"板塊俯衝", k:"地震火山", d:"位於環太平洋地震帶，地震與火山活動頻繁" },
        { s:"地理", t:["國九","世界"], e:"印度季風", y:"夏季降雨集中", p:"季風系統", k:"農業依賴", d:"季風帶來大量雨水，影響農業生產" },
        { s:"地理", t:["國九","世界"], e:"地中海盆地", y:"文明搖籃", p:"海洋貿易", k:"文化交流", d:"溫暖氣候與海運促進古代文明發展" },
        { s:"地理", t:["國九","世界"], e:"北極圈", y:"極夜極晝", p:"地軸傾角", k:"冰蓋", d:"高緯度造成極端日照與寒冷環境" },
        { s:"地理", t:["國九","世界"], e:"東南亞群島", y:"群島國家", p:"板塊與海平面", k:"火山與地震", d:"群島地形多火山與地震，海運與漁業重要" },
        { s:"地理", t:["國九","世界"], e:"拉丁美洲高原", y:"安地斯山脈", p:"造山運動", k:"高原農業", d:"高海拔地區發展特殊農業與礦業" },

        // [高中] GIS 與 地圖
        { s:"地理", t:["高一","地圖"], e:"麥卡托投影", y:"角度正確", p:"航海", k:"高緯放大", d:"適合航海導航，但高緯度面積嚴重變形" },
        { s:"地理", t:["高一","地圖"], e:"等高線", y:"地形起伏", p:"地形圖", k:"閉合曲線", d:"連線上海拔高度相同的點，顯示地形坡度" },
        { s:"地理", t:["高一","GIS"], e:"向量資料", y:"點線面", p:"GIS", k:"幾何圖形", d:"用座標與點線面來儲存地理資訊" },
        { s:"地理", t:["高一","GIS"], e:"網格資料", y:"像元", p:"衛星影像", k:"解析度", d:"將地表切割成網格，紀錄屬性數值" },
        { s:"地理", t:["高一","地圖"], e:"比例尺種類", y:"數字與文字比例", p:"地圖製圖", k:"換算", d:"比例尺表示地圖與實際距離的關係，分為數字、文字與圖形" },
        { s:"地理", t:["高一","地圖"], e:"等值線圖", y:"等溫線等壓線", p:"資料表示", k:"連續曲線", d:"用等值線表示氣溫、氣壓等連續變化的地理資料" },
        { s:"地理", t:["高一","GIS"], e:"空間分析", y:"緩衝區分析", p:"GIS運算", k:"疊圖分析", d:"利用GIS進行空間查詢與分析，如緩衝區與疊圖" },
        { s:"地理", t:["高一","GIS"], e:"地理資料庫", y:"屬性表", p:"資料管理", k:"資料庫設計", d:"儲存地理要素與屬性資料，便於查詢與分析" },
        { s:"地理", t:["高一","遙測"], e:"多光譜影像", y:"波段資訊", p:"遙測分析", k:"植被指數", d:"不同波段可用於辨識植被、水體與地表材質" },
        { s:"地理", t:["高一","遙測"], e:"雷達遙測", y:"穿雲觀測", p:"微波回波", k:"地形測繪", d:"雷達可穿透雲層，適合地形與地表變化監測" },
        { s:"地理", t:["高一","地形"], e:"侵蝕與堆積", y:"地貌演化", p:"外力作用", k:"風化", d:"風化、侵蝕與堆積共同塑造地表地貌" },
        { s:"地理", t:["高一","氣候"], e:"大氣環流", y:"哈德利環流", p:"熱力差異", k:"赤道上升", d:"全球大尺度大氣環流系統影響各地氣候" },
        { s:"地理", t:["高一","氣候"], e:"洋流影響", y:"暖流與寒流", p:"海洋熱量輸送", k:"沿岸氣候", d:"洋流改變沿岸氣候並影響漁業資源" },
        { s:"地理", t:["高一","人文"], e:"人口分布", y:"聚落型態", p:"自然與經濟因素", k:"都市群", d:"地形、氣候與資源影響人口分布與聚落型態" },
        { s:"地理", t:["高一","地圖"], e:"投影種類", y:"等距等面等角", p:"投影變形", k:"用途選擇", d:"不同投影保留不同屬性，依用途選擇適合投影" },
        { s:"地理", t:["高一","GIS"], e:"地理編碼", y:"地址轉座標", p:"資料整合", k:"地理定位", d:"將地址或地名轉換為座標以便地圖呈現" },
        { s:"地理", t:["高一","遙測"], e:"熱紅外影像", y:"地表溫度", p:"熱輻射", k:"城市熱島", d:"熱紅外可用於測量地表溫度與熱島效應" },

        // [高二] 人口、都市、經濟
        { s:"地理", t:["高二","人口"], e:"人口成長", y:"自然增加", p:"出生死亡率", k:"人口金字塔", d:"出生與死亡率決定自然增加，影響年齡結構" },
        { s:"地理", t:["高二","都市"], e:"都市化", y:"都市擴張", p:"工業化", k:"郊區化", d:"工業與服務業發展促進人口向都市集中" },
        { s:"地理", t:["高二","交通"], e:"交通網絡", y:"樞紐城市", p:"經濟連結", k:"物流", d:"交通樞紐促進區域經濟與人流物流集散" },
        { s:"地理", t:["高二","能源"], e:"化石燃料", y:"煤石油天然氣", p:"能源供應", k:"溫室氣體", d:"傳統能源供應穩定但排放溫室氣體，影響氣候" },
        { s:"地理", t:["高二","能源"], e:"再生能源", y:"風力太陽能", p:"低碳轉型", k:"能源分散化", d:"再生能源減少碳排放並分散能源供應風險" },
        { s:"地理", t:["高二","環境"], e:"水資源管理", y:"集水區", p:"人為利用", k:"水利工程", d:"集水區特性與人類活動影響水資源可用性" },
        { s:"地理", t:["高二","環境"], e:"土壤侵蝕", y:"水土流失", p:"不當耕作", k:"坡地農業", d:"不當土地利用加劇土壤流失，影響農業與生態" },
        { s:"地理", t:["高二","產業"], e:"全球供應鏈", y:"分工專業化", p:"貿易自由化", k:"跨國公司", d:"全球化使生產分工跨國界，影響區域產業結構" },
        { s:"地理", t:["高二","區域"], e:"經濟特區", y:"產業聚落", p:"政策誘因", k:"外資", d:"政策與地理條件吸引投資，形成產業聚落" },
        { s:"地理", t:["高二","人口"], e:"人口老化", y:"高齡社會", p:"生育率下降", k:"社會福利", d:"低生育與高壽命導致人口結構老化，影響社會政策" },
        { s:"地理", t:["高二","環境"], e:"空氣污染", y:"懸浮微粒", p:"工業與交通", k:"健康影響", d:"工業排放與車輛廢氣是主要空污來源" },
        { s:"地理", t:["高二","產業"], e:"服務業", y:"第三產業", p:"都市化", k:"就業結構", d:"隨都市化與經濟發展，服務業比重上升" },

        // [高三] 全球議題與應用
        { s:"地理", t:["高三","全球化"], e:"貿易路徑", y:"海運航線", p:"地理位置", k:"樞紐港", d:"地理位置決定航運路徑與港口重要性" },
        { s:"地理", t:["高三","永續"], e:"氣候變遷", y:"溫室效應", p:"人為排放", k:"海平面上升", d:"溫室氣體增加導致全球暖化與海平面上升" },
        { s:"地理", t:["高三","永續"], e:"糧食安全", y:"產量穩定性", p:"氣候與技術", k:"糧食進口依賴", d:"氣候變遷與土地退化威脅糧食供應穩定" },
        { s:"地理", t:["高三","能源"], e:"能源轉型", y:"低碳經濟", p:"政策與技術", k:"電網現代化", d:"從化石燃料轉向低碳能源需配套政策與技術" },
        { s:"地理", t:["高三","都市"], e:"都市熱島", y:"溫度上升", p:"土地覆蓋改變", k:"綠地不足", d:"都市化與不透水面增加導致局部溫度上升" },
        { s:"地理", t:["高三","環境"], e:"海岸侵蝕", y:"海岸後退", p:"海平面上升與人為活動", k:"防波堤", d:"海平面上升與人為干擾加速海岸侵蝕" },
        { s:"地理", t:["高三","地緣政治"], e:"資源爭奪", y:"能源與水資源", p:"國際關係", k:"跨界河流", d:"稀缺資源可能成為國際爭端的來源" },
        { s:"地理", t:["高三","區域"], e:"都市更新", y:"再生計畫", p:"土地重劃", k:"社區參與", d:"都市更新需兼顧經濟效益與社會正義" },
        { s:"地理", t:["高三","科技"], e:"智慧城市", y:"感測與資料", p:"物聯網", k:"即時監控", d:"運用感測器與資料分析提升城市管理效率" },
        { s:"地理", t:["高三","永續"], e:"生物多樣性", y:"棲地保育", p:"人類活動", k:"保護區", d:"保護棲地與連通性是維持生物多樣性的關鍵" },
        { s:"地理", t:["高三","永續"], e:"碳足跡", y:"排放量計算", p:"消費與生產", k:"減碳策略", d:"衡量個人或產業溫室氣體排放以制定減碳策略" },
        { s:"地理", t:["高三","全球化"], e:"跨國公司", y:"全球布局", p:"資本流動", k:"生產外移", d:"跨國公司透過全球布局分散生產與市場" },
        { s:"地理", t:["高三","永續"], e:"循環經濟", y:"資源再利用", p:"廢棄物管理", k:"減廢", d:"透過資源回收與再利用降低環境負擔" },
        { s:"地理", t:["高三","環境"], e:"濕地保育", y:"生態服務", p:"棲地保護", k:"碳匯", d:"濕地提供生態服務並具碳匯與防洪功能" },
        { s:"地理", t:["高三","地緣政治"], e:"海權與陸權", y:"地理戰略", p:"地理位置", k:"通道控制", d:"地理位置影響國家戰略與海陸權力分配" }
    ];

    // ⭐ 專屬地理的生成器 (函式名稱加上 _Safe 避免衝突)
    function generateGeoOptions_Safe(G, db, item, field) {
        const { shuffle } = G.utils;
        const correctAns = item[field].trim();
        
        // 建立 Set 避免重複
        const selected = new Set();
        selected.add(correctAns);
        const wrongOpts = [];

        // 策略 A: 優先找「地理資料庫內」且「同單元」的錯誤選項 (例如都是氣候)
        // 即使題目被鎖定在"國七"，錯誤選項也可以來自其他年級的同類概念，增加誘答性
        const sameUnit = shuffle(db.filter(x => x.t[1] === item.t[1]));
        
        for(const cand of sameUnit) {
            const txt = cand[field].trim();
            if(!selected.has(txt)) {
                wrongOpts.push(txt);
                selected.add(txt);
            }
            if(wrongOpts.length >= 3) break;
        }

        // 策略 B: 如果不夠，從「整個地理資料庫」找
        if(wrongOpts.length < 3) {
            const allGeo = shuffle(db);
            for(const cand of allGeo) {
                const txt = cand[field].trim();
                if(!selected.has(txt)) {
                    wrongOpts.push(txt);
                    selected.add(txt);
                }
                if(wrongOpts.length >= 3) break;
            }
        }

        const finalOpts = shuffle([correctAns, ...wrongOpts]);
        return {
            options: finalOpts,
            answer: finalOpts.indexOf(correctAns)
        };
    }

    // 註冊模板
    function registerGeoTemplates(G, geoDB) {
        const { pick } = G.utils;

        // 定義所有可能的年級標籤
        const allGrades = ["國七", "國八", "國九", "高一", "高二", "高三"];

        // ★ 核心函式：根據使用者標籤過濾題目
        function filterByGrade(db, userTags) {
            // 找出使用者選了哪個年級 (例如 ["地理", "國七"] -> "國七")
            const targetGrade = userTags.find(tag => allGrades.includes(tag));
            
            if (targetGrade) {
                // 如果有指定年級，只回傳該年級的題目
                const filtered = db.filter(item => item.t[0] === targetGrade);
                // 防呆：萬一該年級沒題目，回傳全部以免當機
                return filtered.length > 0 ? filtered : db;
            }
            // 沒指定年級 (例如只選 "地理")，回傳全部
            return db;
        }

        // 1. 地理敘述題
        G.registerTemplate('geo_feat', (ctx) => {
            // ★ 第一步：先過濾題目
            const validDB = filterByGrade(geoDB, ctx.tags || []);
            const item = pick(validDB);
            
            // 呼叫專屬生成器
            const { options, answer } = generateGeoOptions_Safe(G, geoDB, item, 'y');
            
            // 決定視覺化標籤 (Image Tag)
            let imageTag = "";
            if (item.t[1] === "地形") {
                 imageTag = ``;
            } else if (item.t[1] === "氣候") {
                 imageTag = ``;
            } else if (item.t[1] === "地圖" || item.t[1] === "GIS") {
                 imageTag = ``;
            }

            return {
                question: `【地理】關於「${item.e}」，下列敘述何者正確？`,
                options: options,
                answer: answer,
                concept: item.t[1],
                explanation: [
                    `正確答案：${item.y}`, 
                    `說明：${item.d}`,
                    imageTag
                ]
            };
        }, ["geography", "地理", "社會", "國七", "國八", "國九", "高一", "高二", "高三"]);

        // 2. 地理關鍵字題
        G.registerTemplate('geo_key', (ctx) => {
            // ★ 第一步：先過濾題目
            const validDB = filterByGrade(geoDB, ctx.tags || []);
            const item = pick(validDB);
            
            // 呼叫專屬生成器
            const { options, answer } = generateGeoOptions_Safe(G, geoDB, item, 'k');

            return {
                question: `【地理】提到「${item.e}」，通常會聯想到哪個關鍵詞？`,
                options: options,
                answer: answer,
                concept: item.t[1],
                explanation: [`${item.e} 關鍵詞：${item.k}`, `成因：${item.p}`]
            };
        }, ["geography", "地理", "社會", "國七", "國八", "國九", "高一", "高二", "高三"]);
    }

    // 啟動
    waitForEngine(G => {
        registerGeoTemplates(G, geoDB);
        console.log("🌏 地理題庫 (年級鎖定 + 嚴格去重 + 圖解版) 已載入！");
    });

})(window);
