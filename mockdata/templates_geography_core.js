(function (global) {
    'use strict';

    // ç­‰å¾…å¼•æ“å°±ç·’
    function waitForEngine(callback) {
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        if (!G || !G.registerTemplate) {
            setTimeout(() => waitForEngine(callback), 100);
            return;
        }
        callback(G);
    }

    // åœ°ç†æ ¸å¿ƒè³‡æ–™åº«
    function buildGeoDB() {
        return [
            // åœ‹ä¸ƒ å°ç£åœ°ç†
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"æ²³è°·åœ°å½¢", y:"Vå‹è°·", p:"æ²³æµä¾µè•", k:"ä¸Šæ¸¸", d:"æ²³æµä¸Šæ¸¸ä¾µè•åŠ›å¼·ï¼Œä¸‹åˆ‡å½¢æˆæ·±è°·" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"æ²–ç©æ‰‡", y:"æ‰‡ç‹€å †ç©", p:"æ²³æµå †ç©", k:"è°·å£", d:"æ²³æµå‡ºè°·å£æµé€Ÿæ¸›ç·©ï¼Œæ³¥æ²™å †ç©æˆæ‰‡ç‹€" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"ä¸‰è§’æ´²", y:"æ²³å£å †ç©", p:"æ²³æµ", k:"å‡ºæµ·å£", d:"æ²³æµå…¥æµ·è™•æµé€Ÿæ¥µæ…¢ï¼Œæ³¥æ²™å †ç©æˆä¸‰è§’å½¢" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"çŸ³ç°å²©åœ°å½¢", y:"å–€æ–¯ç‰¹", p:"æº¶è•ä½œç”¨", k:"é˜ä¹³çŸ³", d:"åœ°ä¸‹æ°´æº¶è•çŸ³ç°å²©å±¤å½¢æˆçš„ç‰¹æ®Šåœ°å½¢" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"æ²™æ´²èˆ‡æ½Ÿæ¹–", y:"æ³¢æµªå †ç©", p:"æ²¿æµ·", k:"æ¿±å¤–æ²™æ´²", d:"æ²¿å²¸æµèˆ‡æ³¢æµªæ¬é‹å †ç©å½¢æˆçš„æµ·ç©åœ°å½¢" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","æ°£å€™"], e:"å­£é¢¨æ°£å€™", y:"å¤é›¨å†¬ä¹¾", p:"æµ·é™¸æ€§è³ªå·®ç•°", k:"è½‰å‘", d:"å¤å­£å¹æµ·é¢¨å¤šé›¨ï¼Œå†¬å­£å¹é™¸é¢¨ä¹¾ç‡¥" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","æ°£å€™"], e:"åœ°å½¢é›¨", y:"è¿é¢¨å¡å¤šé›¨", p:"åœ°å½¢æŠ¬å‡", k:"èƒŒé¢¨å¡", d:"æ°£æµå—å±±è„ˆé˜»æ“‹æŠ¬å‡ï¼Œå†·å»å‡çµé™é›¨" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","ç”¢æ¥­"], e:"é›†ç´„è¾²æ¥­", y:"æŠ•å…¥å¤šç”¢å‡ºé«˜", p:"æ°´ç¨»", k:"å‹åŠ›å¯†é›†", d:"å–®ä½é¢ç©æŠ•å…¥å¤§é‡å‹åŠ›èˆ‡è³‡é‡‘çš„è¾²æ¥­" },

            // åœ‹å…« ä¸­åœ‹åœ°ç†
            { s:"åœ°ç†", t:["åœ‹å…«","ä¸­åœ‹"], e:"é»ƒåœŸé«˜åŸ", y:"çª¯æ´", p:"é¢¨åŠ›å †ç©", k:"æ°´åœŸæµå¤±", d:"åœŸè³ªç–é¬†ï¼Œæ˜“å—æµæ°´ä¾µè•ï¼Œå½¢æˆæºå£‘ç¸±æ©«" },
            { s:"åœ°ç†", t:["åœ‹å…«","ä¸­åœ‹"], e:"åå…’äº•", y:"ä¹¾ç‡¥æ°£å€™", p:"æ–°ç–†", k:"æš—æ¸ ", d:"æ¸›å°‘æ°´åˆ†è’¸ç™¼çš„å¤è€æ°´åˆ©è¨­æ–½" },
            { s:"åœ°ç†", t:["åœ‹å…«","ä¸­åœ‹"], e:"é•·æ±Ÿä¸‰è§’æ´²", y:"æ°´é„‰æ¾¤åœ‹", p:"æ°´é‹", k:"é­šç±³ä¹‹é„‰", d:"æ²³ç¶²å¯†å¸ƒï¼Œä¸­åœ‹ç¶“æ¿Ÿæœ€ç™¼é”çš„åœ°å€" },

            // åœ‹ä¹ ä¸–ç•Œåœ°ç†
            { s:"åœ°ç†", t:["åœ‹ä¹","ä¸–ç•Œ"], e:"ç†±å¸¶é›¨æ—", y:"äºé¦¬éœ", p:"èµ¤é“", k:"å°æµé›¨", d:"å…¨å¹´é«˜æº«å¤šé›¨ï¼Œç”Ÿç‰©å¤šæ¨£æ€§é«˜" },
            { s:"åœ°ç†", t:["åœ‹ä¹","ä¸–ç•Œ"], e:"ç†±å¸¶è½åŸ", y:"ä¹¾æº¼åˆ†æ˜", p:"ç…å­æ–‘é¦¬", k:"è–©å‡¡ç´", d:"å—èµ¤é“ä½å£“èˆ‡å‰¯ç†±å¸¶é«˜å£“äº¤æ›¿æ§åˆ¶ï¼Œä¹¾æº¼å­£æ˜é¡¯" },
            { s:"åœ°ç†", t:["åœ‹ä¹","ä¸–ç•Œ"], e:"åœ°ä¸­æµ·å‹æ°£å€™", y:"å¤ä¹¾å†¬é›¨", p:"è¥¿é¢¨å¸¶", k:"æ©„æ¬–è‘¡è„", d:"å¤å­£ä¹¾ç‡¥å°‘é›¨ï¼Œå†¬å­£å—è¥¿é¢¨å¹æ‹‚å¤šé›¨" },
            { s:"åœ°ç†", t:["åœ‹ä¹","ä¸–ç•Œ"], e:"æº«å¸¶æµ·æ´‹æ€§", y:"å…¨å¹´æœ‰é›¨", p:"è¥¿æ­", k:"è¥¿é¢¨å¹æ‹‚", d:"çµ‚å¹´å—è¥¿é¢¨èˆ‡æš–æµå½±éŸ¿ï¼Œæ°£å€™æº«å’Œæ¿•æ½¤" },

            // é«˜ä¸­ é€šè«–åœ°ç†
            { s:"åœ°ç†", t:["é«˜ä¸€","åœ°åœ–"], e:"éº¥å¡æ‰˜æŠ•å½±", y:"è§’åº¦æ­£ç¢º", p:"èˆªæµ·", k:"é«˜ç·¯æ”¾å¤§", d:"é©åˆèˆªæµ·å°èˆªï¼Œä½†é«˜ç·¯åº¦é¢ç©åš´é‡è®Šå½¢" },
            { s:"åœ°ç†", t:["é«˜ä¸€","åœ°åœ–"], e:"ç­‰é«˜ç·š", y:"åœ°å½¢èµ·ä¼", p:"åœ°å½¢åœ–", k:"é–‰åˆæ›²ç·š", d:"é€£ç·šä¸Šæµ·æ‹”é«˜åº¦ç›¸åŒçš„é»ï¼Œé¡¯ç¤ºåœ°å½¢å¡åº¦" },
            { s:"åœ°ç†", t:["é«˜ä¸€","GIS"], e:"å‘é‡è³‡æ–™", y:"é»ç·šé¢", p:"GIS", k:"å¹¾ä½•åœ–å½¢", d:"ç”¨åº§æ¨™èˆ‡é»ç·šé¢ä¾†å„²å­˜åœ°ç†è³‡è¨Š" },
            { s:"åœ°ç†", t:["é«˜ä¸€","GIS"], e:"ç¶²æ ¼è³‡æ–™", y:"åƒå…ƒ", p:"è¡›æ˜Ÿå½±åƒ", k:"è§£æåº¦", d:"å°‡åœ°è¡¨åˆ‡å‰²æˆç¶²æ ¼ï¼Œç´€éŒ„å±¬æ€§æ•¸å€¼" }
        ];
    }

    // ----------------------------------------------------
    // é€šç”¨é¸é …ç”Ÿæˆå™¨ (é‡å°åœ°ç†ç§‘å„ªåŒ–)
    // ----------------------------------------------------
    function generateStrictOptions(G, db, item, field) {
        const { shuffle } = G.utils;
        const correctAns = item[field].trim();
        
        // 1. ä½¿ç”¨ Set å»é‡ï¼Œæ”¾å…¥æ­£ç¢ºç­”æ¡ˆ
        const selected = new Set();
        selected.add(correctAns);
        const wrongOpts = [];

        // 2. ç­–ç•¥ A: å„ªå…ˆæ‰¾ã€ŒåŒå–®å…ƒã€(t[1]) çš„éŒ¯èª¤ç­”æ¡ˆ (ä¾‹å¦‚éƒ½æ˜¯åœ°å½¢)
        // é€™æ¨£èª˜ç­”åŠ›è¼ƒé«˜ï¼Œä¸æœƒå‡ºç¾å•åœ°å½¢å»å‡ºç¾æ°£å€™çš„é¸é …
        const sameTag = shuffle(db.filter(x => x.t[1] === item.t[1]));
        for(const cand of sameTag) {
            const txt = cand[field].trim();
            if(!selected.has(txt)) {
                wrongOpts.push(txt);
                selected.add(txt);
            }
            if(wrongOpts.length >= 3) break;
        }

        // 3. ç­–ç•¥ B: å¦‚æœåŒå–®å…ƒé¡Œç›®å¤ªå°‘ï¼Œå¾å…¨åŸŸè£œè¶³
        if(wrongOpts.length < 3) {
            const all = shuffle(db);
            for(const cand of all) {
                const txt = cand[field].trim();
                if(!selected.has(txt)) {
                    wrongOpts.push(txt);
                    selected.add(txt);
                }
                if(wrongOpts.length >= 3) break;
            }
        }

        // 4. çµ„åˆä¸¦å›å‚³
        const finalOpts = shuffle([correctAns, ...wrongOpts]);
        return {
            options: finalOpts,
            answer: finalOpts.indexOf(correctAns)
        };
    }

    // è¨»å†Šæ¨¡æ¿
    function registerTemplates(G, geoDB) {
        const { pick } = G.utils;

        // 1. åœ°ç†ç‰¹å¾µé¡Œ (è€ƒ item.y)
        G.registerTemplate('geo_feat', () => {
            const item = pick(geoDB);
            const { options, answer } = generateStrictOptions(G, geoDB, item, 'y');

            return {
                question: `ã€åœ°ç†ã€‘é—œæ–¼ã€Œ${item.e}ã€ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ`,
                options: options,
                answer: answer,
                concept: item.t[1],
                explanation: [`æ­£ç¢ºç­”æ¡ˆï¼š${item.y}`, `èªªæ˜ï¼š${item.d}`]
            };
        }, ["geography", "åœ°ç†", "ç¤¾æœƒ", "åœ‹ä¸ƒ", "åœ‹å…«", "åœ‹ä¹", "é«˜ä¸€"]);

        // 2. åœ°ç†é—œéµå­—é¡Œ (è€ƒ item.k)
        G.registerTemplate('geo_key', () => {
            const item = pick(geoDB);
            const { options, answer } = generateStrictOptions(G, geoDB, item, 'k');

            return {
                question: `ã€åœ°ç†ã€‘æåˆ°ã€Œ${item.e}ã€ï¼Œé€šå¸¸æœƒè¯æƒ³åˆ°å“ªå€‹é—œéµè©ï¼Ÿ`,
                options: options,
                answer: answer,
                concept: item.t[1],
                explanation: [`${item.e} é—œéµè©ï¼š${item.k}`, `æˆå› ï¼š${item.p}`]
            };
        }, ["geography", "åœ°ç†", "ç¤¾æœƒ", "åœ‹ä¸ƒ", "åœ‹å…«", "åœ‹ä¹", "é«˜ä¸€"]);
    }

    waitForEngine(G => {
        const geoDB = buildGeoDB();
        registerTemplates(G, geoDB);
        console.log("ğŸŒ åœ°ç†é¡Œåº«ï¼ˆåš´æ ¼å»é‡ç‰ˆï¼‰å·²è¼‰å…¥ï¼");
    });

})(window);
