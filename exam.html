<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Êô∫ÊÖßË©ïÈáèÁ≥ªÁµ± - Áø∞ÊûóÈõ≤Á´ØÂ≠∏Èô¢</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
    rel="stylesheet" />

<style>
body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f6f8; }
.option-card { border: 2px solid #e5e7eb; transition: .2s; }
.option-card:hover { border-color: #3b82f6; background: #eff6ff; }
.option-card.selected { border-color: #2563eb; background: #eff6ff; }
.q-nav-btn { width:36px;height:36px;border-radius:50%;border:1px solid #cbd5e1; }
.q-nav-btn.active { background:#3b82f6;color:white; }
.q-nav-btn.answered { background:#e5e7eb; }
</style>

<!-- ‰Ω†ÂéüÊú¨ÁöÑ JSÔºå‰∏ÄÂÄãÈÉΩÊ≤íÂãï -->
<script src="mockdata/users.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/generator_engine.js"></script>
<script src="mockdata/AutoTemplateFissionFactory.js"></script>
<script src="mockdata/auto_fission_bootstrap.js"></script>
<script src="mockdata/paper_generator.js"></script>
<script src="mockdata/curriculum_integrated.js"></script>

<script src="mockdata/templates_math_algebra_geometry.js"></script>
<script src="mockdata/templates_physics_multistep.js"></script>
<script src="mockdata/templates_chemistry_core.js"></script>
<script src="mockdata/templates_biology_core.js"></script>
<script src="mockdata/templates_english_core.js"></script>
<script src="mockdata/templates_english_vocab_7000.js"></script>
<script src="mockdata/templates_chinese_core.js"></script>
<script src="mockdata/templates_history_core.js"></script>
</head>

<body class="h-screen flex flex-col">

<header class="bg-white shadow h-16 flex items-center justify-between px-6">
    <h1 id="examTitle" class="font-bold text-lg">ËºâÂÖ•‰∏≠...</h1>
    <div class="flex gap-4 items-center">
        <span id="timer" class="font-mono text-red-600">00:00</span>
        <button id="submitBtnTop"
            class="bg-orange-500 text-white px-4 py-2 rounded">‰∫§Âç∑</button>
    </div>
</header>

<main class="flex flex-grow overflow-hidden">
<aside class="w-64 bg-white border-r p-4 hidden lg:block">
    <div id="questionPalette" class="grid grid-cols-5 gap-2"></div>
</aside>

<section class="flex-grow p-6 overflow-y-auto">
<div class="bg-white rounded-xl shadow p-8">
    <div class="flex justify-between mb-4">
        <span id="conceptBadge"
            class="text-xs font-bold px-3 py-1 rounded-full bg-purple-100 text-purple-700 border border-purple-200">
        </span>
        <span class="font-mono">Q.<span id="currentQNum">1</span>/<span id="totalQNum">--</span></span>
    </div>

    <h2 id="questionText" class="text-xl font-bold mb-6"></h2>
    <div id="optionsContainer" class="space-y-3"></div>

    <div class="flex justify-between mt-8">
        <button id="prevBtn">‰∏ä‰∏ÄÈ°å</button>
        <button id="nextBtn">‰∏ã‰∏ÄÈ°å</button>
    </div>
</div>
</section>
</main>

<script>
let mockQuestions = [];
let currentQIndex = 0;
let userAnswers = [];
let timeLeft = 0;
let timerInterval;
let examFinished = false;

const els = {
    qText: questionText,
    opts: optionsContainer,
    curr: currentQNum,
    total: totalQNum,
    badge: conceptBadge,
    palette: questionPalette,
    prev: prevBtn,
    next: nextBtn,
    timer,
    submit: submitBtnTop
};

window.onload = () => {
    if (!Auth.requireLogin()) return;
    setTimeout(prepareExam, 100);
};

function prepareExam() {
    const params = new URLSearchParams(location.search);
    const subject = params.get('subject') || 'math';
    const count = parseInt(params.get('count')) || 10;

    mockQuestions = generatePaper({ subject, total: count });
    userAnswers = new Array(mockQuestions.length).fill(null);

    totalQNum.textContent = mockQuestions.length;
    timeLeft = count * 60;

    renderPalette();
    renderQuestion();
    startTimer();
}

function renderQuestion() {
    const q = mockQuestions[currentQIndex];
    els.curr.textContent = currentQIndex + 1;
    els.qText.innerHTML = q.question.replace(/\n/g, '<br>');

    // üî• Tailwind CDN ÂÆâÂÖ®ÁâàÊ®ôÁ±§È°èËâ≤
    els.badge.className =
        "text-xs font-bold px-3 py-1 rounded-full border bg-purple-100 text-purple-700 border-purple-200";
    els.badge.textContent = q.concept || 'Á∂úÂêàÈ°åÂûã';

    els.opts.innerHTML = '';
    q.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'option-card w-full p-4 rounded ' +
            (userAnswers[currentQIndex] === i ? 'selected' : '');
        btn.innerHTML = `<b>${String.fromCharCode(65+i)}.</b> ${opt}`;
        btn.onclick = () => {
            userAnswers[currentQIndex] = i;
            renderQuestion();
            updatePalette();
        };
        els.opts.appendChild(btn);
    });

    if (window.MathJax) MathJax.typesetPromise();
    updateNav();
}

function renderPalette() {
    els.palette.innerHTML = '';
    mockQuestions.forEach((_, i) => {
        const b = document.createElement('button');
        b.textContent = i + 1;
        b.className = 'q-nav-btn';
        b.onclick = () => { currentQIndex = i; renderQuestion(); };
        els.palette.appendChild(b);
    });
}

function updatePalette() {
    [...els.palette.children].forEach((b, i) => {
        b.className = 'q-nav-btn';
        if (userAnswers[i] !== null) b.classList.add('answered');
        if (i === currentQIndex) b.classList.add('active');
    });
}

function updateNav() {
    els.prev.disabled = currentQIndex === 0;
    els.prev.onclick = () => { currentQIndex--; renderQuestion(); };

    if (currentQIndex === mockQuestions.length - 1) {
        els.next.textContent = '‰∫§Âç∑';
        els.next.onclick = finishExam;
    } else {
        els.next.textContent = '‰∏ã‰∏ÄÈ°å';
        els.next.onclick = () => { currentQIndex++; renderQuestion(); };
    }
}

function startTimer() {
    timerInterval = setInterval(() => {
        timeLeft--;
        timer.textContent =
            `${String(Math.floor(timeLeft/60)).padStart(2,'0')}:${String(timeLeft%60).padStart(2,'0')}`;
        if (timeLeft <= 0) finishExam();
    }, 1000);
}

function finishExam() {
    if (examFinished) return;
    examFinished = true;
    clearInterval(timerInterval);
    location.href = 'analysis.html';
}
</script>

</body>
</html>
