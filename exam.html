<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>智慧評量系統 - 雲端學院</title>

  <!-- 你原本的 CSS / Tailwind / Bootstrap 都保留 -->
  <link href="https://cdn.tailwindcss.com" rel="stylesheet" />
</head>

<body class="bg-gray-100">

  <!-- ===== Header（完全不動） ===== -->
  <header class="bg-white shadow px-6 py-3 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <span class="font-bold text-blue-600">雲端學院</span>
      <span class="text-gray-500">｜載入中…</span>
    </div>
    <div class="flex items-center gap-4">
      <span class="text-red-500 font-mono">00:00</span>
      <button class="bg-orange-500 text-white px-4 py-2 rounded">交卷</button>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="flex">

    <!-- 左側答題狀況（保留） -->
    <aside class="w-64 bg-white border-r p-4">
      <h3 class="font-semibold mb-3">答題狀況</h3>
      <div id="palette" class="grid grid-cols-5 gap-2"></div>
    </aside>

    <!-- 題目卡片 -->
    <section class="flex-1 p-8">
      <div class="bg-white rounded-xl shadow p-6 min-h-[420px]">

        <div class="flex justify-between items-center mb-4">
          <div>
            <span class="bg-blue-500 text-white text-sm px-3 py-1 rounded">單選題</span>
            <span id="conceptBadge" class="ml-2 text-purple-500 text-sm"></span>
          </div>
          <div class="text-gray-500">
            Q. <span id="qIndex">1</span> / <span id="qTotal">--</span>
          </div>
        </div>

        <div id="questionArea" class="text-lg mb-6"></div>

        <div id="optionsArea" class="space-y-3"></div>

        <div class="flex justify-between mt-8">
          <button id="prevBtn" class="text-gray-500">← 上一題</button>
          <button id="nextBtn" class="border px-4 py-2 rounded">下一題 →</button>
        </div>

      </div>
    </section>

  </main>

  <!-- ===== 你原本的所有 JS 都照樣載入 ===== -->
  <script src="generator_engine.js"></script>
  <script src="paper_generator.js"></script>
  <script src="auto_fission_bootstrap.js"></script>

  <!-- ===== exam.html 修正版 JS（只動這裡） ===== -->
  <script>
    let questions = [];
    let answers = {};
    let currentQIndex = 0;

    function renderPalette() {
      const el = document.getElementById('palette');
      el.innerHTML = '';
      questions.forEach((_, i) => {
        const b = document.createElement('button');
        b.textContent = i + 1;
        b.className = 'border rounded p-1 text-sm';
        b.onclick = () => {
          currentQIndex = i;
          renderQuestion();
          updatePalette();
        };
        el.appendChild(b);
      });
    }

    function updatePalette() {
      document.querySelectorAll('#palette button').forEach((b, i) => {
        b.classList.toggle('bg-blue-500', i === currentQIndex);
        b.classList.toggle('text-white', i === currentQIndex);
      });
    }

    function renderQuestion() {
      const q = questions[currentQIndex];
      if (!q) return;

      document.getElementById('qIndex').textContent = currentQIndex + 1;
      document.getElementById('qTotal').textContent = questions.length;
      document.getElementById('conceptBadge').textContent = q.concept || '';

      document.getElementById('questionArea').innerHTML = q.question || '';

      const optArea = document.getElementById('optionsArea');
      optArea.innerHTML = '';

      q.options.forEach((opt, idx) => {
        const label = document.createElement('label');
        label.className = 'block border rounded p-3 cursor-pointer';

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'answer';
        radio.checked = answers[currentQIndex] === idx;
        radio.onchange = () => {
          answers[currentQIndex] = idx;
        };

        label.appendChild(radio);
        label.append(' ' + opt);
        optArea.appendChild(label);
      });
    }

    function prepareExam() {
      try {
        const params = new URLSearchParams(location.search);
        const subject = params.get('subject') || 'english';
        const total = Number(params.get('count') || 10);

        questions = generatePaper({ subject, total }) || [];

        if (!questions.length) {
          document.getElementById('questionArea').textContent = '⚠️ 題目載入失敗';
          return;
        }

        renderPalette();
        renderQuestion();
        updatePalette();

      } catch (err) {
        console.error(err);
      }
    }

    document.getElementById('prevBtn').onclick = () => {
      if (currentQIndex > 0) {
        currentQIndex--;
        renderQuestion();
        updatePalette();
      }
    };

    document.getElementById('nextBtn').onclick = () => {
      if (currentQIndex < questions.length - 1) {
        currentQIndex++;
        renderQuestion();
        updatePalette();
      }
    };

    window.addEventListener('load', prepareExam);
  </script>

</body>
</html>
