<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>智慧評量系統 - 翰林雲端學院</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

<script src="mockdata/users.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/generator_engine.js"></script>

<script src="mockdata/AutoTemplateFissionFactory.js"></script>
<script src="mockdata/auto_fission_bootstrap.js"></script>
<script src="mockdata/paper_generator.js"></script>
<script src="mockdata/curriculum_integrated.js"></script>

<script src="mockdata/templates_math_algebra_geometry.js"></script>
<script src="mockdata/templates_physics_multistep.js"></script>
<script src="mockdata/templates_chemistry_core.js"></script>
<script src="mockdata/templates_biology_core.js"></script>
<script src="mockdata/templates_english_core.js"></script>
<script src="mockdata/templates_english_vocab_7000.js"></script>
<script src="mockdata/templates_chinese_core.js"></script>
<script src="mockdata/templates_history_core.js"></script>
<script src="mockdata/templates_geography_core.js"></script>
<script src="mockdata/templates_civics_core.js"></script>
</head>

<body class="h-screen flex flex-col overflow-hidden">

<!-- UI 結構保持不動（略） -->
<!-- 你原本的 header / main / aside 全部 그대로 -->
<!-- ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓ -->

<script>
/* ===============================
 * 全域狀態
 * =============================== */
let mockQuestions = [];
let currentQIndex = 0;
let userAnswers = [];
let timeLeft = 0;
let timerInterval = null;
let examInfo = {};
let examFinished = false;

/* ===============================
 * DOM
 * =============================== */
const els = {
  title: document.getElementById('examTitle'),
  sub: document.getElementById('examSubject'),
  qText: document.getElementById('questionText'),
  opts: document.getElementById('optionsContainer'),
  currNum: document.getElementById('currentQNum'),
  totalNum: document.getElementById('totalQNum'),
  progress: document.getElementById('progressBar'),
  prev: document.getElementById('prevBtn'),
  next: document.getElementById('nextBtn'),
  timer: document.getElementById('timer'),
  submit: document.getElementById('submitBtnTop'),
  badge: document.getElementById('conceptBadge'),
  palette: document.getElementById('questionPalette')
};

/* ===============================
 * 初始化
 * =============================== */
window.onload = () => {
  const user = Auth.requireLogin();
  if (!user) return;

  initCurriculum();
  setTimeout(prepareExam, 200);
};

function initCurriculum() {
  let all = [];
  if (window.CurriculumLibrary?.data) {
    Object.values(window.CurriculumLibrary.data).forEach(d => {
      if (Array.isArray(d)) all = all.concat(d);
    });
  }
  window.Curriculum108 = all;
}

/* ===============================
 * 建立考卷
 * =============================== */
function prepareExam() {
  const url = new URLSearchParams(location.search);
  const courseId = url.get('id');
  let subject = url.get('subject') || 'math';
  const count = parseInt(url.get('count')) || 10;

  let course = null;
  for (const b of (window.Curriculum108 || [])) {
    course = b.courses?.find(c => c.id === courseId);
    if (course) break;
  }

  examInfo = {
    subject: subject.toUpperCase(),
    title: course ? course.name : `${subject} 測驗`,
    timeLimit: count * 60
  };

  timeLeft = examInfo.timeLimit;

  mockQuestions = window.generatePaper
    ? generatePaper({ subject, total: count, tags: course?.tags || [] })
    : [];

  userAnswers = new Array(mockQuestions.length).fill(null);

  els.title.textContent = examInfo.title;
  els.sub.textContent = examInfo.subject;
  els.totalNum.textContent = mockQuestions.length;

  renderPalette();
  renderQuestion();
  startTimer();
}

/* ===============================
 * 題目渲染
 * =============================== */
function renderQuestion() {
  const q = mockQuestions[currentQIndex];
  els.currNum.textContent = currentQIndex + 1;
  els.qText.innerHTML = q.question.replace(/\n/g, '<br>');

  els.opts.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    const sel = userAnswers[currentQIndex] === i;
    btn.className = `option-card w-full p-4 rounded-xl ${sel ? 'selected' : ''}`;
    btn.innerHTML = `<b>${String.fromCharCode(65+i)}</b>. ${opt}`;
    btn.onclick = () => {
      userAnswers[currentQIndex] = i;
      renderQuestion();
      updatePalette();
    };
    els.opts.appendChild(btn);
  });

  els.progress.style.width = `${(currentQIndex+1)/mockQuestions.length*100}%`;
  updateNav();
}

/* ===============================
 * 交卷（重點修正）
 * =============================== */
function finishExam() {
  if (examFinished) return;
  examFinished = true;

  clearInterval(timerInterval);

  const unanswered = userAnswers.filter(a => a === null).length;
  if (unanswered > 0 && !confirm(`尚有 ${unanswered} 題未作答，確定交卷？`)) {
    examFinished = false;
    startTimer();
    return;
  }

  const currentUser =
    JSON.parse(localStorage.getItem("currentUser")) ||
    { username: "guest" };

  let correct = 0;
  let wrongList = [];

  mockQuestions.forEach((q, i) => {
    if (userAnswers[i] === q.answer) correct++;
    else wrongList.push({ ...q, yourAns: userAnswers[i] });
  });

  const record = {
    id: Date.now(),
    user: currentUser.username,
    subject: examInfo.subject,
    title: examInfo.title,
    score: Math.round(correct / mockQuestions.length * 100),
    correctCount: correct,
    totalCount: mockQuestions.length,
    wrongList,
    date: new Date().toLocaleString()
  };

  const key = `history_${currentUser.username}`;
  const history = JSON.parse(localStorage.getItem(key) || "[]");
  history.push(record);
  localStorage.setItem(key, JSON.stringify(history));
  localStorage.setItem("examResult", JSON.stringify(record));

  location.href = "analysis.html";
}

/* ===============================
 * 其他
 * =============================== */
function startTimer() {
  timerInterval = setInterval(() => {
    timeLeft--;
    els.timer.textContent =
      String(Math.floor(timeLeft/60)).padStart(2,'0') + ':' +
      String(timeLeft%60).padStart(2,'0');
    if (timeLeft <= 0) finishExam();
  }, 1000);
}

function updateNav() {
  els.prev.disabled = currentQIndex === 0;
  els.next.onclick = currentQIndex === mockQuestions.length - 1
    ? finishExam
    : () => { currentQIndex++; renderQuestion(); };
}

els.prev.onclick = () => { if (currentQIndex > 0) { currentQIndex--; renderQuestion(); }};
els.submit.onclick = finishExam;
</script>
</body>
</html>
