<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§è©•é‡ç³»çµ± - ç¿°æ—é›²ç«¯å­¸é™¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f6f8; }
        .option-card { transition: all 0.2s ease-in-out; border: 2px solid #e2e8f0; }
        .option-card:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .option-card.selected { border-color: #2563eb; background-color: #eff6ff; color: #1e3a8a; font-weight: 500; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1); }
        .q-nav-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid #cbd5e1; background: white; color: #64748b; transition: all 0.2s; }
        .q-nav-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .q-nav-btn.answered { background-color: #e2e8f0; color: #475569; border-color: #94a3b8; }
        .q-nav-btn.active.answered { background-color: #2563eb; color: white; border-color: #2563eb; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <script src="mockdata/users.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/generator_engine.js"></script>
    
    <script src="mockdata/AutoTemplateFissionFactory.js"></script>
    <script src="mockdata/auto_fission_bootstrap.js"></script>
    <script src="mockdata/paper_generator.js"></script>

    <script src="mockdata/curriculum_integrated.js"></script>

    <script src="mockdata/templates_math_algebra_geometry.js"></script>
    <script src="mockdata/templates_physics_multistep.js"></script>
    <script src="mockdata/templates_chemistry_core.js"></script>
    <script src="mockdata/templates_biology_core.js"></script>
    <script src="mockdata/templates_english_core.js"></script>
    <script src="mockdata/templates_english_vocab_7000.js"></script>
    <script src="mockdata/templates_chinese_core.js"></script>
    <script src="mockdata/templates_history_core.js"></script>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-white shadow-sm border-b border-gray-200 h-16 flex-shrink-0 z-20 relative">
        <div class="max-w-screen-2xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="dashboard.html" class="flex items-center gap-2 group">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-blue-700 rounded text-white flex items-center justify-center font-bold text-lg shadow-sm">ç¿°</div>
                    <span class="text-xl font-bold text-gray-800 tracking-wide group-hover:text-blue-600 transition">é›²ç«¯å­¸é™¢</span>
                </a>
                <div class="h-6 w-px bg-gray-300 mx-2 hidden md:block"></div>
                <div class="hidden md:flex flex-col justify-center">
                    <h1 class="text-sm font-bold text-gray-700 leading-tight" id="examTitle">è¼‰å…¥ä¸­...</h1>
                    <div class="flex items-center gap-2 text-xs text-gray-500 mt-0.5">
                        <span id="examSubject" class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-600">ç§‘ç›®</span>
                        <span>â€¢</span>
                        <span class="text-blue-600 font-medium flex items-center gap-1"><i class="fas fa-robot text-[10px]"></i> AI æ™ºèƒ½ç”Ÿæˆ</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-red-50 text-red-600 px-3 py-1.5 rounded-lg border border-red-100 shadow-sm">
                    <i class="far fa-clock mr-2 animate-pulse"></i>
                    <span id="timer" class="font-mono font-bold text-lg tabular-nums">00:00</span>
                </div>
                <button id="submitBtnTop" class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-5 py-2 rounded-lg shadow-md font-bold text-sm">
                    <i class="fas fa-paper-plane mr-2"></i>äº¤å·
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow flex bg-[#f4f6f8] relative overflow-hidden">
        <aside class="w-72 bg-white border-r border-gray-200 flex-col hidden lg:flex shadow-sm z-10">
            <div class="p-5 border-b border-gray-100"><h3 class="font-bold text-gray-700">ç­”é¡Œç‹€æ³</h3></div>
            <div class="flex-grow overflow-y-auto p-5">
                <div class="grid grid-cols-5 gap-3" id="questionPalette"></div>
            </div>
        </aside>

        <div class="flex-grow flex justify-center overflow-y-auto scroll-smooth relative" id="mainScroll">
            <div class="w-full max-w-3xl py-8 px-4 md:px-8">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 min-h-[500px] flex flex-col fade-in relative overflow-hidden">
                    <div class="w-full bg-gray-100 h-1.5 absolute top-0 left-0">
                        <div id="progressBar" class="bg-blue-600 h-1.5 transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="p-8 md:p-10 flex-grow">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex items-center gap-3">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">å–®é¸é¡Œ</span>
                                <span id="conceptBadge" class="bg-purple-100 text-purple-700 text-xs font-bold px-3 py-1 rounded-full border border-purple-200"></span>
                            </div>
                            <span class="text-gray-400 text-sm font-bold font-mono">Q.<span id="currentQNum" class="text-gray-800 text-2xl mx-1">1</span>/<span id="totalQNum">--</span></span>
                        </div>
                        <div class="mb-8"><h2 id="questionText" class="text-2xl font-bold text-gray-800 leading-relaxed"></h2></div>
                        <div id="optionsContainer" class="space-y-3"></div>
                    </div>
                    <div class="bg-gray-50 px-8 py-5 border-t border-gray-100 flex justify-between items-center">
                        <button id="prevBtn" class="text-gray-500 font-bold hover:text-blue-600 flex items-center gap-2"><i class="fas fa-arrow-left"></i> ä¸Šä¸€é¡Œ</button>
                        <button id="nextBtn" class="bg-white border border-gray-300 hover:border-blue-500 hover:text-blue-600 text-gray-700 px-6 py-2 rounded-lg font-bold shadow-sm flex items-center gap-2">ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                <div class="h-10"></div>
            </div>
        </div>
    </main> 
<script>
(function () {
  'use strict';

  let mockQuestions = [];
  let currentQIndex = 0;
  let userAnswers = [];
  let timeLeft = 0;
  let timerInterval;
  let examInfo = {};

  const els = {
    title: document.getElementById('examTitle'),
    sub: document.getElementById('examSubject'),
    qText: document.getElementById('questionText'),
    opts: document.getElementById('optionsContainer'),
    currNum: document.getElementById('currentQNum'),
    totalNum: document.getElementById('totalQNum'),
    progress: document.getElementById('progressBar'),
    prev: document.getElementById('prevBtn'),
    next: document.getElementById('nextBtn'),
    timer: document.getElementById('timer'),
    submit: document.getElementById('submitBtnTop'),
    badge: document.getElementById('conceptBadge'),
    palette: document.getElementById('questionPalette')
  };

  const BADGE_CLASS_MAP = {
    red: 'text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide border bg-red-100 text-red-700 border-red-200',
    green: 'text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide border bg-green-100 text-green-700 border-green-200',
    blue: 'text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide border bg-blue-100 text-blue-700 border-blue-200',
    purple: 'text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide border bg-purple-100 text-purple-700 border-purple-200',
    gray: 'text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide border bg-gray-100 text-gray-700 border-gray-200'
  };

  function waitForGenerator(timeout = 2000) {
    return new Promise((resolve) => {
      const start = Date.now();
      function check() {
        const G = window.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        const P = window.PaperGeneratorV2;
        const ready = (P && typeof P.generate === 'function') || (G && G._templates && Object.keys(G._templates).length > 0 && typeof G.generateQuestion === 'function');
        if (ready) return resolve(true);
        if (Date.now() - start > timeout) return resolve(false);
        setTimeout(check, 60);
      }
      check();
    });
  }

  // ======= æ··åˆè£‚è®Šé¡Œç”Ÿæˆ =======
  function makeQuestionsWithFission(subject, count = 10, courseTags = [], fissionRatio = 0.4) {
    const P = window.PaperGeneratorV2;
    const G = window.RigorousGenerator || (window.global && window.global.RigorousGenerator);
    const results = [];
    const fissionCount = Math.floor(count * fissionRatio);
    const normalCount = count - fissionCount;

    // ç”Ÿæˆè£‚è®Šé¡Œ
    for (let i = 0; i < fissionCount; i++) {
      let q = P.generate(subject);
      if (G && G._templates && G.autoFissionRegister) {
        const fissionTemplates = Object.keys(G._templates).filter(id => id.includes('_fission_'));
        if (fissionTemplates.length) {
          const tid = fissionTemplates[Math.floor(Math.random() * fissionTemplates.length)];
          const fq = G.generateQuestion(tid);
          if (fq) q = { ...fq, concept: (fq.concept || '') + " (æ‡‰ç”¨)" };
        }
      }
      results.push(q);
    }

    // ç”Ÿæˆå‰©é¤˜åŸå§‹é¡Œ
    for (let i = 0; i < normalCount; i++) {
      results.push(P.generate(subject));
    }

    // æ‰“äº‚é †åº
    return results.sort(() => Math.random() - 0.5);
  }

  function normalizeQuestions(raw) {
    return raw.map((q, idx) => {
      if (!q || typeof q !== 'object') return { question: String(q || 'é¡Œç›®å…§å®¹ç¼ºå¤±'), options: ['ç„¡é¸é …'], answer: 0, concept: 'ä¸€èˆ¬é¡Œå‹' };
      const question = q.question || q.q || 'é¡Œç›®å…§å®¹ç¼ºå¤±';
      const options = Array.isArray(q.options) ? q.options.slice() : ['ç„¡é¸é …'];
      const answer = (typeof q.answer === 'number') ? q.answer : 0;
      const concept = q.concept || 'ä¸€èˆ¬é¡Œå‹';
      if (options.length === 1) options.push('ï¼ˆç„¡æ›´å¤šé¸é …ï¼‰');
      return { question: String(question), options, answer, concept };
    });
  }

  // ======= é¡Œå‹çµ±è¨ˆ badge =======
  function computeConceptStats() {
    const stats = {};
    mockQuestions.forEach(q => {
      const c = q.concept || 'å…¶ä»–';
      stats[c] = (stats[c] || 0) + 1;
    });
    return stats;
  }

  function renderConceptBadge() {
    const stats = computeConceptStats();
    const arr = Object.entries(stats).map(([k,v])=>`${k} ${v}`);
    els.badge.textContent = arr.join(' / ');
    els.badge.className = BADGE_CLASS_MAP.purple;
  }

  function renderQuestion() {
    const q = mockQuestions[currentQIndex];
    if (!q) return;

    els.currNum.textContent = currentQIndex + 1;
    els.qText.innerHTML = q.question.replace(/\n/g, '<br>');

    // é¸é …
    els.opts.innerHTML = '';
    q.options.forEach((opt, idx) => {
      const isSelected = userAnswers[currentQIndex] === idx;
      const label = String.fromCharCode(65 + idx);
      const btn = document.createElement('button');
      btn.className = `option-card w-full text-left p-4 rounded-xl flex items-center group relative ${isSelected ? 'selected' : 'bg-white text-gray-700'}`;
      btn.innerHTML = `<span class="option-badge w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full font-bold mr-4 border transition-colors ${isSelected ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-500'}">${label}</span><span class="text-lg leading-snug font-medium">${opt}</span>`;
      btn.onclick = () => { userAnswers[currentQIndex] = idx; renderQuestion(); updatePaletteStatus(); };
      els.opts.appendChild(btn);
    });

    if (window.MathJax && typeof MathJax.typesetPromise === 'function') {
      MathJax.typesetPromise([els.qText, els.opts]).catch(err => console.warn(err));
    }

    els.progress.style.width = `${((currentQIndex + 1) / mockQuestions.length) * 100}%`;
    updateNav();
    updatePaletteStatus();
    renderConceptBadge();
  }

  function renderPalette() {
    els.palette.innerHTML = '';
    mockQuestions.forEach((_, idx) => {
      const btn = document.createElement('button');
      btn.className = 'q-nav-btn';
      btn.textContent = idx + 1;
      btn.id = `palette-btn-${idx}`;
      btn.onclick = () => { currentQIndex = idx; renderQuestion(); };
      els.palette.appendChild(btn);
    });
  }

  function updatePaletteStatus() {
    mockQuestions.forEach((_, idx) => {
      const btn = document.getElementById(`palette-btn-${idx}`);
      if (!btn) return;
      btn.classList.toggle('active', idx === currentQIndex);
      btn.classList.toggle('answered', userAnswers[idx] !== null && userAnswers[idx] !== undefined);
    });
  }

  function updateNav() {
    els.prev.disabled = currentQIndex === 0;
    if (currentQIndex === mockQuestions.length - 1) {
      els.next.innerHTML = 'äº¤å· <i class="fas fa-check ml-2"></i>';
      els.next.className = "bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-green-700 transition flex items-center gap-2";
      els.next.onclick = finishExam;
    } else {
      els.next.innerHTML = 'ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right ml-2"></i>';
      els.next.className = "bg-white border border-gray-300 hover:border-blue-500 text-gray-700 px-6 py-2 rounded-lg font-bold shadow-sm transition flex items-center gap-2";
      els.next.onclick = () => { currentQIndex++; renderQuestion(); };
    }
  }

  els.prev.onclick = () => { if(currentQIndex > 0) { currentQIndex--; renderQuestion(); }};
  els.submit.onclick = finishExam;

  function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      timeLeft--;
      const m = String(Math.floor(timeLeft/60)).padStart(2,'0');
      const s = String(timeLeft%60).padStart(2,'0');
      els.timer.textContent = `${m}:${s}`;
      if (timeLeft <= 0) { clearInterval(timerInterval); finishExam(true); }
    }, 1000);
  }

  function finishExam(isAuto=false) {
    const unanswered = userAnswers.filter(a=>a===null||a===undefined).length;
    if(!isAuto && unanswered>0) { if(!confirm(`é‚„æœ‰ ${unanswered} é¡Œæœªä½œç­”ï¼Œç¢ºå®šäº¤å·ï¼Ÿ`)) return; }
    clearInterval(timerInterval);

    let correctCount = 0, wrongList=[];
    mockQuestions.forEach((q, idx) => {
      if(userAnswers[idx]===q.answer) correctCount++;
      else wrongList.push({ question:q.question, options:q.options, correctAns:q.answer, yourAns:userAnswers[idx], explanation:q.explanation||"åƒè€ƒèª²æœ¬å…§å®¹", concept:q.concept });
    });

    const record = {
      id: Date.now(),
      date: new Date().toLocaleString(),
      subject: examInfo.subject,
      title: examInfo.title,
      score: Math.round((correctCount/mockQuestions.length)*100),
      correctCount,
      totalCount:mockQuestions.length,
      wrongList
    };

    const username = (window.currentUser && window.currentUser.username) || "guest";
    const storageKey = `history_${username}`;
    let history = JSON.parse(localStorage.getItem(storageKey) || "[]");
    history.push(record);
    localStorage.setItem(storageKey, JSON.stringify(history));
    localStorage.setItem('examResult', JSON.stringify(record));
    window.location.href = "analysis.html";
  }

  async function prepareExam() {
    const urlParams = new URLSearchParams(window.location.search);
    const subject = urlParams.get('subject') || 'math';
    const count = parseInt(urlParams.get('count')) || 10;
    const ready = await waitForGenerator(1500);

    let rawQuestions = makeQuestionsWithFission(subject, count, [], 0.4);
    mockQuestions = normalizeQuestions(rawQuestions);
    if(mockQuestions.length===0) mockQuestions = normalizeQuestions([{question:'ç³»çµ±éŒ¯èª¤ï¼šç„¡é¡Œç›®å¯é¡¯ç¤º',options:['é‡æ–°æ•´ç†'],'answer':0,'concept':'ç³»çµ±'}]);

    userAnswers = new Array(mockQuestions.length).fill(null);
    examInfo = { subject: subject.toUpperCase(), title: `${subject} æ¸¬é©—`, timeLimit: count*60 };
    timeLeft = examInfo.timeLimit;

    els.title.textContent = examInfo.title;
    els.sub.textContent = examInfo.subject;
    els.totalNum.textContent = mockQuestions.length;

    renderPalette();
    renderQuestion();
    startTimer();
  }

  window.addEventListener('load', () => {
    prepareExam().catch(e=>console.error(e));
  });

})();
</script>

<script>
(function(global){
    'use strict';

    // ================================
    // 1. PaperGeneratorV2 ä¸»é«” + æ“´å……
    // ================================
    const SUBJECT_MAP = {
        'social': ['history', 'geography', 'civics', 'æ­·å²', 'åœ°ç†', 'å…¬æ°‘', 'ç¤¾æœƒ'],
        'natural': ['physics', 'chemistry', 'biology', 'earth_science', 'ç‰©ç†', 'åŒ–å­¸', 'ç”Ÿç‰©', 'åœ°ç§‘', 'è‡ªç„¶'],
        'math': ['math', 'æ•¸å­¸'],
        'chinese': ['chinese', 'åœ‹æ–‡'],
        'english': ['english', 'è‹±æ–‡']
    };

    const PaperGeneratorV2 = {
        generate: function(subjectReq, gradeReq) {
            const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
            if (!G) return this.createFallbackQuestion("å¼•æ“æœªå°±ç·’", "è«‹æª¢æŸ¥æ ¸å¿ƒ JS æ˜¯å¦è¼‰å…¥");

            const targetTags = SUBJECT_MAP[subjectReq] || [subjectReq];
            const allIds = Object.keys(G._templates || {});
            let candidates = allIds.filter(id => {
                const qTags = G._templateTags?.[id] || [];
                const hasSub = qTags.some(t => targetTags.some(target => t.toLowerCase().includes(target.toLowerCase())));
                const hasGrade = !gradeReq || qTags.some(t => t.includes(gradeReq));
                return hasSub && hasGrade;
            });

            // é™ç´šç­–ç•¥
            if (candidates.length === 0) {
                candidates = allIds.filter(id => {
                    const qTags = G._templateTags?.[id] || [];
                    return qTags.some(t => targetTags.some(target => t.toLowerCase().includes(target.toLowerCase())));
                });
            }

            if (candidates.length === 0) {
                return this.createFallbackQuestion(subjectReq, gradeReq, "é¡Œåº«ä¸­ç„¡ç¬¦åˆæ¨™ç±¤ä¹‹é¡Œç›®");
            }

            const templateId = candidates[Math.floor(Math.random() * candidates.length)];
            const questionData = G.generateQuestion?.(templateId) || {};
            return {
                question: questionData.question || "é¡Œç›®å…§å®¹ç¼ºå¤±",
                options: questionData.options || ["ç„¡é¸é …"],
                answer: typeof questionData.answer === 'number' ? questionData.answer : 0,
                concept: questionData.concept || "ä¸€èˆ¬é¡Œå‹",
                subject: subjectReq,
                grade: gradeReq
            };
        },

        createFallbackQuestion: function(sub, grd, reason) {
            return {
                question: `<div style="color:red">ã€ç³»çµ±è¨Šæ¯ï¼š${reason}ã€‘</div>è«‹ç¢ºèª <b>templates_${sub}_core.js</b> æ˜¯å¦æ­£ç¢ºè¼‰å…¥ã€‚`,
                options: ["è«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘", "è«‹ç¢ºèªæ¨™ç±¤å®šç¾©", "é‡æ–°æ•´ç†"],
                answer: 0,
                concept: "é™¤éŒ¯æç¤º"
            };
        }
    };

    global.PaperGeneratorV2 = PaperGeneratorV2;
    console.log("âœ… PaperGeneratorV2 å·²å°±ç·’");

})(this);
</script>

<script>
(function(global){
    'use strict';

    function initFissionFactory() {
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        if (!G || !G.utils) { setTimeout(initFissionFactory, 50); return; }

        const DB = {
            roles: ["AIå·¥ç¨‹å¸«", "YouTuber", "å¤–é€å“¡", "åµæ¢", "å¤ªç©ºäºº", "ä¸»å»š", "é›»ç«¶é¸æ‰‹", "é­”æ³•å¸«", "ç§‘å­¸å®¶", "å·¥ç¨‹å¸«"],
            places: ["åœ¨ä¾¿åˆ©å•†åº—", "åœ¨ç«æ˜ŸåŸºåœ°", "åœ¨å¤è€åœ–æ›¸é¤¨", "åœ¨ç›´æ’­é–“", "åœ¨ç„¡äººå³¶", "åœ¨è·¨å¹´æ™šæœƒ", "åœ¨å¯¦é©—å®¤", "åœ¨ç«¶è³½å ´åœ°"],
            formats: [
                { type: "news", tpl: q=>`ã€å¿«è¨Šã€‘${q} å°ˆå®¶åˆ†æçµæœ` },
                { type: "chat", tpl: q=>`Aï¼šã€Œè€ƒä½ ä¸€é¡Œï¼š${q}ã€ Bï¼šã€Œé€™ç°¡å–®...ã€` },
                { type: "diary", tpl: q=>`ã€æ—¥è¨˜ã€‘è€å¸«å•äº†ï¼š${q}` },
                { type: "guide", tpl: q=>`ã€æ”»ç•¥ã€‘æ–°æ‰‹æ•™å­¸ï¼š${q}` },
                { type: "problem", tpl: q=>`ã€æŒ‘æˆ°é¡Œã€‘è§£æ±ºæ­¤å•é¡Œï¼š${q}` }
            ]
        };

        const CONTEXT_WRAPPERS = { 'standard': q => q };
        const { pick, shuffle } = G.utils;

        // 20ç¨®æƒ…å¢ƒè£‚è®Š
        for (let i = 0; i < 20; i++) {
            CONTEXT_WRAPPERS[`role_py_${i}`] = q => {
                const r = pick(DB.roles);
                const p = pick(DB.places);
                return `ã€æƒ…å¢ƒï¼š${r}ã€‘ä½ ${p}é‡åˆ°å•é¡Œï¼šã€Œ${q}ã€è«‹ä»¥å°ˆæ¥­èº«ä»½å›ç­”ã€‚`;
            };
        }
        DB.formats.forEach(fmt => CONTEXT_WRAPPERS[fmt.type] = fmt.tpl);

        G.autoFissionRegister = function(origId, origFunc, tags, rawRegister) {
            rawRegister.call(G, origId, origFunc, tags);
            const keys = Object.keys(CONTEXT_WRAPPERS).filter(k => k!=='standard');
            const key = pick(keys);
            const wrapper = CONTEXT_WRAPPERS[key];
            const fissionId = `${origId}_fission_${key}`;

            const newFunc = function(ctx, rnd) {
                const data = origFunc(ctx, rnd);
                if (data && typeof data.question==='string') {
                    return {
                        ...data,
                        question: wrapper(data.question),
                        concept: `${data.concept || ''} (æ‡‰ç”¨)`,
                        templateId: fissionId
                    };
                }
                return data;
            };
            rawRegister.call(G, fissionId, newFunc, [...tags, "ç´ é¤Š","è£‚è®Š"]);
        };
        console.log("âœ… è£‚è®Šå·¥å» å°±ç·’");
    }

    window.addEventListener('load', function() {
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        if (!G || !G.autoFissionRegister) { setTimeout(initFissionFactory, 50); } 
        else initFissionFactory();

        function bootstrap(G) {
            if (!G._rawRegister) G._rawRegister = G.registerTemplate;
            G.registerTemplate = function(name, func, tags=[]) {
                try { G.autoFissionRegister(name, func, tags, G._rawRegister); }
                catch(e){ G._rawRegister.call(G, name, func, tags); }
            };
            console.log("ğŸš€ è£‚è®Šæ””æˆªå™¨å•Ÿå‹•");
        }

        if (G) bootstrap(G);
        else setTimeout(() => {
            const G2 = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
            if(G2) bootstrap(G2);
        }, 300);
    });
})(this);
</script>

</body>
</html>
