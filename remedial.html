<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>錯題補救 - 系統診斷模式</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }</style>
</head>
<body class="p-8">

    <div class="max-w-4xl mx-auto space-y-6">
        
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-slate-800">錯題補救 (系統診斷模式)</h1>
            <a href="dashboard.html" class="bg-gray-200 px-4 py-2 rounded text-gray-700 font-bold">回首頁</a>
        </div>

        <div class="bg-blue-50 border border-blue-200 p-6 rounded-xl">
            <h2 class="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2">
                <i class="fas fa-microchip"></i> 資料庫狀態診斷
            </h2>
            <div class="space-y-2 text-sm font-mono text-blue-900">
                <p>目前的 LocalStorage 共有 <span id="storageCount" class="font-bold text-red-600 text-lg">0</span> 筆資料。</p>
                <div class="bg-white p-4 rounded border border-blue-100 h-40 overflow-y-auto" id="rawOutput">
                    (資料讀取中...)
                </div>
            </div>
            <button onclick="forceInject()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow">
                <i class="fas fa-magic"></i> 強制寫入測試資料 (按我!)
            </button>
            <p class="text-xs text-blue-400 mt-2">* 如果按了按鈕還是沒反應，請檢查瀏覽器是否開啟了「阻擋 Cookie/本地儲存」。</p>
        </div>

        <div id="questionArea" class="space-y-4">
            </div>

    </div>

    <script>
        // === 1. 診斷邏輯：列出所有資料 ===
        function diagnoseStorage() {
            const rawBox = document.getElementById('rawOutput');
            const countBox = document.getElementById('storageCount');
            
            let html = '<ul class="list-disc pl-5">';
            let foundWrong = false;
            let totalItems = localStorage.length;

            countBox.textContent = totalItems;

            if (totalItems === 0) {
                html += '<li class="text-red-500">資料庫是空的 (Empty)！請確認您不是在無痕模式，或按下方按鈕寫入資料。</li>';
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    const size = (value.length / 1024).toFixed(2);
                    
                    // 標記錯題本 Key
                    if (key.includes('wrong_questions')) {
                        foundWrong = true;
                        html += `<li class="text-green-600 font-bold">${key} (大小: ${size} KB) ✅ 找到錯題本！</li>`;
                    } else {
                        html += `<li class="text-gray-500">${key} (大小: ${size} KB)</li>`;
                    }
                }
            }
            html += '</ul>';
            rawBox.innerHTML = html;

            if (foundWrong) {
                loadAndRender();
            } else {
                document.getElementById('questionArea').innerHTML = `
                    <div class="text-center p-10 text-gray-400">
                        <i class="fas fa-search text-4xl mb-2"></i><br>
                        尚未發現錯題資料，請點擊上方按鈕測試。
                    </div>`;
            }
        }

        // === 2. 強制寫入 (Force Inject) ===
        window.forceInject = function() {
            const fakeData = [
                {
                    question: "【系統測試】如果你看到這題，代表錯題本功能正常！",
                    options: ["選項A", "選項B", "選項C", "選項D"],
                    answer: 0,
                    yourAns: 1,
                    concept: "系統診斷",
                    explanation: ["這是一條由系統強制寫入的測試資料。", "請嘗試去考一次試，確認真實錯題是否能寫入。"]
                }
            ];
            
            // 寫入兩種常見的 Key，確保一定抓得到
            localStorage.setItem('wrong_questions_guest', JSON.stringify(fakeData));
            try {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (user && user.username) {
                    localStorage.setItem(`wrong_questions_${user.username}`, JSON.stringify(fakeData));
                }
            } catch(e) {}

            alert("✅ 已強制寫入測試資料！頁面將重新整理。");
            location.reload();
        }

        // === 3. 讀取並渲染 ===
        function loadAndRender() {
            let allWrongs = [];
            
            // 暴力掃描所有錯題 Key
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith("wrong_questions")) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (Array.isArray(data)) allWrongs = allWrongs.concat(data);
                    } catch(e) {}
                }
            }

            const container = document.getElementById('questionArea');
            container.innerHTML = `<h3 class="text-xl font-bold text-gray-700 mb-4">錯題列表 (${allWrongs.length} 題)</h3>`;

            allWrongs.forEach((q, idx) => {
                const explain = Array.isArray(q.explanation) ? q.explanation.join('<br>') : q.explanation;
                
                let optsHtml = '';
                q.options.forEach((opt, i) => {
                    let color = 'bg-white';
                    if (i === q.answer) color = 'bg-green-100 text-green-800 border-green-300';
                    else if (i === q.yourAns) color = 'bg-red-100 text-red-800 border-red-300';
                    optsHtml += `<div class="p-2 border rounded mb-1 ${color}">${opt}</div>`;
                });

                container.innerHTML += `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-red-500 text-white text-xs px-2 py-1 rounded">錯題 ${idx+1}</span>
                            <span class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded">${q.concept || '一般'}</span>
                        </div>
                        <h4 class="text-lg font-bold mb-4">${q.question}</h4>
                        <div class="space-y-1 mb-4">${optsHtml}</div>
                        <div class="bg-slate-100 p-4 rounded text-sm text-slate-700">
                            <strong>解析：</strong><br>${explain}
                        </div>
                    </div>
                `;
            });
        }

        // 啟動診斷
        diagnoseStorage();

    </script>
</body>
</html>
